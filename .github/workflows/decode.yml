name: Decode JavaScript File

on:
  workflow_dispatch:
    inputs:
      input_path:
        description: "Path to input JS"
        required: false
        default: "input.js"
      output_path:
        description: "Path to output JS"
        required: false
        default: "output.js"
  push:
    branches: [ main ]
    paths:
      - 'input.js'

jobs:
  decode:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show chosen paths
        run: |
          echo "INPUT:  ${{ github.event.inputs.input_path || 'input.js' }}"
          echo "OUTPUT: ${{ github.event.inputs.output_path || 'output.js' }}"

      - name: Execute Python script for decoding
        run: |
          python src/decode.py

      - name: Install dependencies and run decode
        run: |
          npm ci || npm i
          npm run decode -- -i "${{ github.event.inputs.input_path || 'input.js' }}" -o "${{ github.event.inputs.output_path || 'output.js' }}"

      - name: Configure Git author
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "action"

      - name: Save decoded output to repository
        run: |
          git status
          ls -lah
          git add "${{ github.event.inputs.output_path || 'output.js' }}" || true
          git commit -m "Add decoded output file" || echo "no changes"
          git push
