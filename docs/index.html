<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OtOjs · Eval/Packer 解密前端</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body{background:#0b0f14;color:#e6eef7;font-family:sans-serif;margin:0;padding:20px}
    .wrap{max-width:960px;margin:auto}
    .card{background:#0f1621;border:1px solid #223046;border-radius:10px;padding:12px;margin:10px 0}
    textarea,pre,input{width:100%;background:#0b1020;color:#e6eef7;border:1px solid #223046;border-radius:8px;padding:8px}
    button{margin:4px;padding:8px 12px;border-radius:8px;border:1px solid #2b3b54;background:#152033;color:#e6eef7;cursor:pointer}
    button.ok{border-color:#10b981} button.warn{border-color:#f59e0b} button.err{border-color:#ef4444}
    pre{white-space:pre-wrap;word-break:break-word}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>OtOjs · Eval/Packer 解密前端</h1>

    <!-- 基础配置 -->
    <div class="card">
      <div class="row">
        <div style="flex:2">
          <label>REPO</label>
          <input id="repo" value="Mikephie/OtOjs" />
        </div>
        <div>
          <label>BRANCH</label>
          <input id="branch" value="main" />
        </div>
        <div>
          <label>Token（contents:rw）</label>
          <input id="token" type="password" placeholder="ghp_..." />
        </div>
      </div>
    </div>

    <!-- 输入 -->
    <div class="card">
      <small>把待解密脚本放到 <b>input.js</b> → Actions 自动跑 → 拉回输出文件并智能解密</small>
      <div class="row compact">
        <input type="file" id="file" accept=".js,.txt,.json" />
        <button onclick="pick()">文件</button>
        <input id="remoteUrl" placeholder="https:// 原始脚本 URL" />
        <button onclick="loadRemote()">远程</button>
        <button onclick="pasteFromClipboard()">粘贴</button>
        <button class="err" onclick="clrIn()">清空</button>
      </div>
      <textarea id="codeIn" placeholder="把待解密 JS 粘贴到这里，或用上方导入"></textarea>
      <div class="row compact">
        <button class="ok" onclick="runLocalDecode()">解密</button>
        <button onclick="beautify()">美化</button>
        <button onclick="copySel('#codeOut', this)">复制</button>
        <button class="err" onclick="clrAll()">清空全部</button>
      </div>
      <pre id="codeOut" placeholder="结果将显示在这里"></pre>
    </div>

    <!-- 输出 -->
    <div class="card">
      <div class="row compact">
        <button onclick="loadOutputRaw('output/output.js')">拉取 output.js</button>
        <button onclick="loadOutputRaw('output/output.deob2.js')">拉取 deob2.js</button>
        <button onclick="copySel('#outputRaw', this)">复制结果</button>
        <button onclick="downloadOutput()">下载</button>
      </div>
      <pre id="outputRaw"></pre>
    </div>
  </div>

<script>
/* ========== 工具函数，全挂到 window，避免按钮失效 ========== */
window.clrIn = function(){ document.querySelector('#codeIn').value=''; }
window.clrAll = function(){ 
  document.querySelector('#codeIn').value=''; 
  document.querySelector('#codeOut').textContent=''; 
  document.querySelector('#outputRaw').textContent='';
}
window.copySel = async function(sel, btn){
  const t=document.querySelector(sel).textContent;
  if(!t) return;
  await navigator.clipboard.writeText(t);
  const old=btn.textContent; btn.textContent='✅ 已复制';
  setTimeout(()=>btn.textContent=old,1200);
}
window.pasteFromClipboard = async function(){
  const text = await navigator.clipboard.readText();
  document.querySelector('#codeIn').value = text;
}
window.pick = function(){
  document.getElementById('file').click();
}
document.getElementById('file').addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return;
  const txt=await f.text();
  document.querySelector('#codeIn').value=txt;
});
window.loadRemote = async function(){
  const url=document.getElementById('remoteUrl').value.trim();
  if(!url) return alert('请输入 URL');
  const res=await fetch(url.replace('/blob/','/raw/'));
  const txt=await res.text();
  document.querySelector('#codeIn').value=txt;
}
window.downloadOutput = function(){
  const blob=new Blob([document.querySelector('#outputRaw').textContent],{type:"text/plain"});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download="output.js";a.click();
}

/* ========== Eval/Packer 解码器 ========== */
function parsePacker(code){
  const re=/eval\(function\(p,a,c,k,e,(?:r|d)\)\{.*\}\((['"])(.*?)\1,(\d+),(\d+),(['"])(.*?)\5\.split\(['"]\|['"]\),\d*,\{\}\)\)/s;
  const m=code.match(re);
  if(!m) return null;
  const payload=m[2], radix=parseInt(m[3]), count=parseInt(m[4]), words=m[6].split('|');
  function baseN(c){return (c<radix?'':baseN(parseInt(c/radix)))+((c=c%radix)>35?String.fromCharCode(c+29):c.toString(36));}
  let out=payload;
  for(let i=count-1;i>=0;i--){
    const key=baseN(i);
    if(words[i]) out=out.replace(new RegExp('\\b'+key+'\\b','g'),words[i]);
  }
  return out;
}

/* ========== 解密按钮逻辑 ========== */
window.runLocalDecode = function(){
  let code=document.querySelector('#codeIn').value;
  let decoded=parsePacker(code);
  if(decoded){ document.querySelector('#codeOut').textContent=decoded; return; }
  const m=code.match(/eval\((['"`])([\s\S]*?)\1\)/);
  if(m) document.querySelector('#codeOut').textContent=m[2];
  else document.querySelector('#codeOut').textContent='未识别到 packer/eval';
}
window.beautify = function(){
  let raw=document.querySelector('#codeOut').textContent;
  if(!raw) return;
  try{
    raw = raw.replace(/;\s*(?!\n)/g,';\n').replace(/\}\s*(?!\n)/g,'}\n');
    document.querySelector('#codeOut').textContent=raw;
  }catch(e){alert('美化失败: '+e.message);}
}
window.loadOutputRaw = async function(path){
  try{
    const url=`https://raw.githubusercontent.com/${document.getElementById('repo').value}/${document.getElementById('branch').value}/${path}`;
    const res=await fetch(url);
    const txt=await res.text();
    document.querySelector('#outputRaw').textContent=txt;
  }catch(e){alert('拉取失败: '+e.message);}
}
</script>
</body>
</html>
