<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OtOjs · 解密前端（自动轮询 + 智能解密）</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="wrap">
    <h1>OtOjs · 解密前端（自动轮询 + 智能解密）</h1>

    <!-- 基础配置 -->
    <div class="card">
      <div class="row">
        <div style="flex:2">
          <label>REPO</label>
          <input id="repo" value="Mikephie/OtOjs" />
        </div>
        <div>
          <label>BRANCH</label>
          <input id="branch" value="main" />
        </div>
        <div>
          <label>Token（contents:rw）</label>
          <input id="token" type="password" placeholder="ghp_..." />
        </div>
      </div>
    </div>

    <!-- 输入 -->
    <div class="card">
      <small>把待解密脚本放到 <b>input.js</b> → Actions 自动跑 → 拉回输出文件并智能解密</small>
      <div class="row compact">
        <input type="file" id="file" accept=".js,.txt,.json" />
        <button onclick="pick()">文件</button>
        <input id="remoteUrl" placeholder="https:// 原始脚本 URL（支持 github/blob 自动转 raw）" />
        <button onclick="loadRemote()">远程</button>
        <button onclick="pasteFromClipboard()">粘贴</button>
        <button class="err" onclick="clrIn()">清空</button>
      </div>
      <textarea id="codeIn" placeholder="把待解密 JS 粘贴到这里，或用上方导入"></textarea>
      <div class="row compact">
        <button class="ok" onclick="submitInput()">提交</button>
        <button class="warn" onclick="startAutoPoll()">轮询</button>
        <button onclick="beautify()">美化</button>
        <button onclick="copySel('#codeOut', this)">复制</button>
        <button class="err" onclick="clrAll()">清空全部</button>
      </div>
      <div class="options">
        <label><input type="checkbox" id="autoDecode" checked /> 自动智能解密</label>
        <label><input type="checkbox" id="autoBeautify" /> 自动美化（Prettier）</label>
        <label><input type="checkbox" id="autoResume" checked /> 后台恢复拉取</label>
      </div>
      <div id="status"><small>状态：就绪</small></div>
      <div class="bar-wrap" id="barWrap" style="display:none"><div class="bar" id="bar"></div></div>
      <pre id="codeOut" placeholder="结果将显示在这里"></pre>
    </div>

    <!-- 输出 -->
    <div class="card">
      <div class="row compact">
        <button onclick="loadOutputRaw('output/output.js')">拉取 output.js</button>
        <button onclick="loadOutputRaw('output/output.deob2.js')">拉取 deob2.js</button>
        <button onclick="copySel('#outputRaw', this)">复制结果</button>
        <button onclick="downloadOutput()">下载</button>
      </div>
      <pre id="outputRaw"></pre>
    </div>
  </div>

  <!-- 顺序非常重要：先插件，再主逻辑 -->
  <script src="decode-all.js"></script>
  <script src="app.js"></script>

  <!-- ① 更稳的复制实现（支持 <pre> 与 <textarea>） -->
  <script>
    async function copySel(sel, btn){
      try{
        const el = document.querySelector(sel);
        const t = el ? (el.value ?? el.textContent ?? '') : '';
        if(!t) throw new Error('没有可复制的内容');
        if(navigator.clipboard?.writeText){
          await navigator.clipboard.writeText(t);
        }else{
          const ta=document.createElement('textarea');
          ta.value=t; ta.style.position='fixed'; ta.style.opacity='0';
          document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
        }
        if(btn){
          const old=btn.textContent; btn.textContent='✅ 已复制';
          setTimeout(()=> btn.textContent=old, 1200);
        }
      }catch(e){ alert('复制失败：' + e.message); }
    }
  </script>

  <!-- ② Prettier 缺插件兜底 + 温和分行（在 ; } ) , 后断行，避开字符串/模板字面量） -->
  <script>
    (function(){
      function lightFormat(src){
        const s=String(src); let out='', inS=false,inD=false,inB=false, esc=false;
        let paren=0, brace=0, bracket=0;
        for(let i=0;i<s.length;i++){
          const ch=s[i];
          if(esc){ out+=ch; esc=false; continue; }
          if(ch==='\\'){ out+=ch; esc=true; continue; }
          if(!inD && !inB && ch=="'"){ inS=!inS; out+=ch; continue; }
          if(!inS && !inB && ch=='"'){ inD=!inD; out+=ch; continue; }
          if(!inS && !inD && ch=='`'){ inB=!inB; out+=ch; continue; }
          if(inS||inD||inB){ out+=ch; continue; }
          if(ch==='(') paren++; if(ch===')') paren=Math.max(0,paren-1);
          if(ch==='{') brace++; if(ch==='}') brace=Math.max(0,brace-1);
          if(ch==='[') bracket++; if(ch===']') bracket=Math.max(0,bracket-1);
          if(ch===';'){ out+=';\n'; }
          else if(ch==='}'){ out+='}\n'; }
          else if(ch===')'){ out+=')\n'; }
          else if(ch===','){ out += (paren+brace+bracket<=2) ? ',\n' : ','; }
          else out+=ch;
        }
        return out.replace(/\n{3,}/g,'\n\n');
      }
      // Prettier shim：当 standalone/插件未就绪时，用 lightFormat 顶替，避免 “estree” 报错
      (function(){
        const needShim =
          typeof window.prettier==='undefined' ||
          typeof window.prettier?.format!=='function' ||
          !window.prettierPlugins;
        if(needShim){
          window.prettier = { format(code){ try{return lightFormat(code);}catch{return String(code);} } };
          window.prettierPlugins = window.prettierPlugins || {};
          console.log('[shim] Prettier 未就绪，启用轻量分行。');
        }
      })();
      // 自动对两个 <pre> 做可读化处理
      function reflowPre(el){
        if(!el) return; const raw=el.textContent||''; if(!raw) return;
        const out=lightFormat(raw); if(out!==raw) el.textContent=out;
      }
      const a=document.getElementById('codeOut'), b=document.getElementById('outputRaw');
      if(a) new MutationObserver(()=> reflowPre(a)).observe(a,{childList:true,subtree:true,characterData:true});
      if(b) new MutationObserver(()=> reflowPre(b)).observe(b,{childList:true,subtree:true,characterData:true});
      window.addEventListener('load', ()=>{ reflowPre(a); reflowPre(b); });
    })();
  </script>

  <!-- 可选：本地化 Prettier（如启用本地文件，app.js 会自动检测并使用，不再走 CDN） -->
  <!--
  <script src="prettier.min.js"></script>
  <script src="parser-babel.min.js"></script>
  -->
</body>
</html>
