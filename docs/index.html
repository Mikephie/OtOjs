HTML <!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>OtOjs · 解密前端（自动轮询 + 智能解密）</title>
        <link rel="stylesheet" href="style.css" />
        <!-- 兜底：强制换行，避免长行一整块 -->
        <style>
            pre {
                white-space: pre-wrap;
                word-break: break-word;
            }
        </style>
    </head>
    <body>
        <div class="wrap">
            <h1>OtOjs · 解密前端（自动轮询 + 智能解密）</h1>
            <!-- 基础配置 -->
            <div class="card">
                <div class="row">
                    <div style="flex: 2;"><label>REPO</label> <input id="repo" value="Mikephie/OtOjs" /></div>
                    <div><label>BRANCH</label> <input id="branch" value="main" /></div>
                    <div><label>Token（contents:rw）</label> <input id="token" type="password" placeholder="ghp_..." /></div>
                </div>
            </div>
            <!-- 输入 -->
            <div class="card">
                <small>把待解密脚本放到 <b>input.js</b> → Actions 自动跑 → 拉回输出文件并智能解密</small>
                <div class="row compact">
                    <input type="file" id="file" accept=".js,.txt,.json" /> <button onclick="pick()">文件</button> <input id="remoteUrl" placeholder="https:// 原始脚本 URL（支持 github/blob 自动转 raw）" />
                    <button onclick="loadRemote()">远程</button> <button onclick="pasteFromClipboard()">粘贴</button> <button class="err" onclick="clrIn()">清空</button>
                </div>
                <textarea id="codeIn" placeholder="把待解密 JS 粘贴到这里，或用上方导入"></textarea>
                <div class="row compact">
                    <button class="ok" onclick="submitInput()">提交</button> <button class="warn" onclick="startAutoPoll()">轮询</button> <button onclick="beautify()">美化</button> <button onclick="copySel('#codeOut', this)">复制</button>
                    <button class="err" onclick="clrAll()">清空全部</button>
                </div>
                <div class="options">
                    <label><input type="checkbox" id="autoDecode" checked /> 自动智能解密</label> <label><input type="checkbox" id="autoBeautify" /> 自动美化（Prettier）</label>
                    <label><input type="checkbox" id="autoResume" checked /> 后台恢复拉取</label>
                </div>
                <div id="status"><small>状态：就绪</small></div>
                <div class="bar-wrap" id="barWrap" style="display: none;"><div class="bar" id="bar"></div></div>
                <pre id="codeOut" placeholder="结果将显示在这里"></pre>
            </div>
            <!-- 输出 -->
            <div class="card">
                <div class="row compact">
                    <button onclick="loadOutputRaw('output/output.js')">拉取 output.js</button> <button onclick="loadOutputRaw('output/output.deob2.js')">拉取 deob2.js</button>
                    <button onclick="copySel('#outputRaw', this)">复制结果</button> <button onclick="downloadOutput()">下载</button>
                </div>
                <pre id="outputRaw"></pre>
            </div>
        </div>
        <!-- 先加载你原有逻辑（保持不变） -->
        <script src="decode-all.js"></script>
        <script src="app.js"></script>
        <!-- 再加载 wrapper（覆盖同名插件：优先使用 aadecode + evalpacker wrapper 实现） -->
        <script src="main/src/wrapper/aadecode-wrapper.js"></script>
        <script src="main/src/wrapper/eval-wrapper.js"></script>
        <!-- 复制按钮（独立，不依赖 app.js 暴露） -->
        <script>
            async function copySel(sel, btn) {
                try {
                    const el = document.querySelector(sel);
                    const t = el ? el.value ?? el.textContent ?? "" : "";
                    if (navigator.clipboard?.writeText) {
                        await navigator.clipboard.writeText(t);
                    } else {
                        const ta = document.createElement("textarea");
                        ta.value = t;
                        document.body.appendChild(ta);
                        ta.select();
                        document.execCommand("copy");
                        ta.remove();
                    }
                    const old = btn.textContent;
                    btn.textContent = "✅ 已复制";
                    setTimeout(() => (btn.textContent = old), 1200);
                } catch (e) {
                    alert("复制失败：" + e.message);
                }
            }
        </script>
        <!-- 展开 \"\\n\" 为真实换行 + 温和断行，保证中间内容可读（不影响解密流程） -->
        <script>
            function expandEscapedNewlines(s) {
                if (typeof s !== "string") return s;
                if (!/\\n|\\r\\n/.test(s)) return s;
                try {
                    const wrapped = '"' + s.replace(/\\/g, "\\\\").replace(/"/g, '\\"') + '"';
                    return JSON.parse(wrapped);
                } catch {
                    return s
                        .replace(/\\r\\n/g, "\n")
                        .replace(/\\n/g, "\n")
                        .replace(/\\t/g, "\t");
                }
            }
            function softBreak(s) {
                if (typeof s !== "string") return s;
                if ((s.match(/\n/g) || []).length >= 5) return s;
                return s
                    .replace(/;\s*(?!\n)/g, ";\n")
                    .replace(/\}\s*(?!\n)/g, "}\n")
                    .replace(/\)\s*;\s*(?!\n)/g, ");\n");
            }
            function reflowPre(el) {
                const raw = el.textContent || "";
                const expanded = expandEscapedNewlines(raw);
                const out = softBreak(expanded);
                if (out !== raw) el.textContent = out;
            } // 自动对两个 <pre> 进行可读性处理（不改变原始解密逻辑） const _mo1 = new MutationObserver(()=> reflowPre(document.getElementById('codeOut'))); const _mo2 = new MutationObserver(()=> reflowPre(document.getElementById('outputRaw'))); window.addEventListener('load', ()=>{ const a=document.getElementById('codeOut'), b=document.getElementById('outputRaw'); if(a) _mo1.observe(a,{childList:true,subtree:true,characterData:true}); if(b) _mo2.observe(b,{childList:true,subtree:true,characterData:true}); });
        </script>
        <!-- 可选：本地化 Prettier（如启用本地文件，app.js 会自动检测并使用，不再走 CDN） -->
        <!-- <script src="prettier.min.js"></script> <script src="parser-babel.min.js"></script> -->
    </body>
</html>
