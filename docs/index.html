<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OtOjs Â· è§£å¯†å‰ç«¯ï¼ˆè‡ªåŠ¨è½®è¯¢ + æ™ºèƒ½è§£å¯†ï¼‰</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="wrap">
    <h1>OtOjs Â· è§£å¯†å‰ç«¯ï¼ˆè‡ªåŠ¨è½®è¯¢ + æ™ºèƒ½è§£å¯†ï¼‰</h1>

    <!-- åŸºç¡€é…ç½® -->
    <div class="card">
      <div class="row">
        <div style="flex:2">
          <label>REPO</label>
          <input id="repo" value="Mikephie/OtOjs" />
        </div>
        <div>
          <label>BRANCH</label>
          <input id="branch" value="main" />
        </div>
        <div>
          <label>Tokenï¼ˆcontents:rwï¼‰</label>
          <input id="token" type="password" placeholder="ghp_..." />
        </div>
      </div>
    </div>

    <!-- è¾“å…¥ -->
    <div class="card">
      <small>æŠŠå¾…è§£å¯†è„šæœ¬æ”¾åˆ° <b>input.js</b> â†’ Actions è‡ªåŠ¨è·‘ â†’ æ‹‰å›è¾“å‡ºæ–‡ä»¶å¹¶æ™ºèƒ½è§£å¯†</small>
      <div class="row compact">
        <input type="file" id="file" accept=".js,.txt,.json" />
        <button onclick="pick()">æ–‡ä»¶</button>
        <input id="remoteUrl" placeholder="https:// åŸå§‹è„šæœ¬ URLï¼ˆæ”¯æŒ github/blob è‡ªåŠ¨è½¬ rawï¼‰" />
        <button onclick="loadRemote()">è¿œç¨‹</button>
        <button onclick="pasteFromClipboard()">ç²˜è´´</button>
        <button class="err" onclick="clrIn()">æ¸…ç©º</button>
      </div>
      <textarea id="codeIn" placeholder="æŠŠå¾…è§£å¯† JS ç²˜è´´åˆ°è¿™é‡Œï¼Œæˆ–ç”¨ä¸Šæ–¹å¯¼å…¥"></textarea>
      <div class="row compact">
        <button class="ok" onclick="submitInput()">æäº¤</button>
        <button class="warn" onclick="startAutoPoll()">è½®è¯¢</button>
        <button onclick="beautify()">ç¾åŒ–</button>
        <button onclick="copySel('#codeOut', this)">å¤åˆ¶</button>
        <button class="err" onclick="clrAll()">æ¸…ç©ºå…¨éƒ¨</button>
        <!-- æ–°å¢å¼ºåˆ¶æ¢è¡ŒæŒ‰é’® -->
        <button onclick="forceCodeWrap()" style="background: var(--accent); border-color: var(--accent); color: white;">ğŸ”§ å¼ºåˆ¶æ¢è¡Œ</button>
      </div>
      <div class="options">
        <label><input type="checkbox" id="autoDecode" checked /> è‡ªåŠ¨æ™ºèƒ½è§£å¯†</label>
        <label><input type="checkbox" id="autoBeautify" /> è‡ªåŠ¨ç¾åŒ–ï¼ˆPrettierï¼‰</label>
        <label><input type="checkbox" id="autoResume" checked /> åå°æ¢å¤æ‹‰å–</label>
      </div>
      <div id="status"><small>çŠ¶æ€ï¼šå°±ç»ª</small></div>
      <div class="bar-wrap" id="barWrap" style="display:none"><div class="bar" id="bar"></div></div>
      <pre id="codeOut" placeholder="ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ"></pre>
    </div>

    <!-- è¾“å‡º -->
    <div class="card">
      <div class="row compact">
        <button onclick="loadOutputRaw('output/output.js')">æ‹‰å– output.js</button>
        <button onclick="loadOutputRaw('output/output.deob2.js')">æ‹‰å– deob2.js</button>
        <button onclick="copySel('#outputRaw', this)">å¤åˆ¶ç»“æœ</button>
        <button onclick="downloadOutput()">ä¸‹è½½</button>
      </div>
      <pre id="outputRaw"></pre>
    </div>
  </div>

  <!-- æ’ä»¶ & ä¸»é€»è¾‘ -->
  <script src="decode-all.js"></script>
  <script src="app.js"></script>

  <!-- ç»ˆæä¿®å¤è„šæœ¬ - å¼ºåˆ¶ä»£ç æ¢è¡Œ -->
  <script>
    // ç»ˆæä»£ç æ˜¾ç¤ºä¿®å¤æ–¹æ¡ˆ
    (function() {
        'use strict';
        
        // å¼ºåˆ¶åº”ç”¨æ¢è¡Œæ ·å¼çš„å‡½æ•°
        function forceWrapStyles(element) {
            if (!element) return;
            
            // å¼ºåˆ¶è®¾ç½®æ¢è¡Œç›¸å…³çš„CSSæ ·å¼
            const styles = {
                'white-space': 'pre-wrap',
                'word-wrap': 'break-word',
                'word-break': 'break-word',
                'overflow-wrap': 'break-word',
                'max-width': '100%',
                'box-sizing': 'border-box',
                'overflow': 'auto'
            };
            
            Object.assign(element.style, styles);
            
            // æ·»åŠ é‡è¦æ€§æ ‡è®°
            for (let prop in styles) {
                element.style.setProperty(prop, styles[prop], 'important');
            }
        }
        
        // æ™ºèƒ½æ¢è¡Œå¤„ç†å‡½æ•°
        function smartWrapCode(text) {
            if (!text || typeof text !== 'string') return text;
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å‹ç¼©çš„æ··æ·†ä»£ç ï¼ˆä¸€è¡Œå¾ˆé•¿ï¼‰
            if (text.length > 1000 && text.split('\n').length < 5) {
                // åœ¨JavaScriptå…³é”®ä½ç½®æ·»åŠ æ¢è¡Œ
                let processed = text
                    // åœ¨åˆ†å·åæ·»åŠ æ¢è¡Œ
                    .replace(/;(?![^(]*\))/g, ';\n')
                    // åœ¨å¤§æ‹¬å·åæ·»åŠ æ¢è¡Œ
                    .replace(/\{/g, '{\n')
                    .replace(/\}/g, '\n}\n')
                    // åœ¨é€—å·åæ·»åŠ æ¢è¡Œï¼ˆå¯¹äºé•¿å‚æ•°åˆ—è¡¨ï¼‰
                    .replace(/,(?=\s*[a-zA-Z_$])/g, ',\n')
                    // åœ¨å…³é”®å­—å‰æ·»åŠ æ¢è¡Œ
                    .replace(/(function\s*\(|eval\s*\(|return\s+|var\s+|let\s+|const\s+)/g, '\n$1')
                    // æ¸…ç†å¤šä½™çš„æ¢è¡Œ
                    .replace(/\n{3,}/g, '\n\n')
                    .replace(/^\n+/, '')
                    .replace(/\n+$/, '');
                    
                return processed;
            }
            
            return text;
        }
        
        // æ‰‹åŠ¨è§¦å‘æ¢è¡Œçš„å…¨å±€å‡½æ•°
        window.forceCodeWrap = function() {
            const codeOut = document.getElementById('codeOut');
            const outputRaw = document.getElementById('outputRaw');
            
            [codeOut, outputRaw].forEach(element => {
                if (element) {
                    forceWrapStyles(element);
                    
                    if (element.textContent) {
                        const wrapped = smartWrapCode(element.textContent);
                        element.textContent = wrapped;
                        console.log('å·²å¼ºåˆ¶æ¢è¡Œå¤„ç†:', element.id);
                    }
                }
            });
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            const status = document.getElementById('status');
            if (status) {
                status.innerHTML = '<small>çŠ¶æ€ï¼šå·²å¼ºåˆ¶æ¢è¡Œå¤„ç† âœ…</small>';
            }
        };
        
        // DOMåŠ è½½å®Œæˆååˆå§‹åŒ–
        function init() {
            const codeOut = document.getElementById('codeOut');
            const outputRaw = document.getElementById('outputRaw');
            
            [codeOut, outputRaw].forEach(element => {
                if (element) {
                    forceWrapStyles(element);
                    
                    // ç›‘å¬å†…å®¹å˜åŒ–
                    if (window.MutationObserver) {
                        const observer = new MutationObserver(() => {
                            forceWrapStyles(element);
                        });
                        
                        observer.observe(element, {
                            childList: true,
                            subtree: true,
                            characterData: true
                        });
                    }
                }
            });
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
        
        // å®šæœŸæ£€æŸ¥æ ·å¼
        setInterval(() => {
            ['codeOut', 'outputRaw'].forEach(id => {
                const element = document.getElementById(id);
                if (element && element.textContent) {
                    const style = window.getComputedStyle(element);
                    if (style.whiteSpace !== 'pre-wrap') {
                        forceWrapStyles(element);
                    }
                }
            });
        }, 3000);
        
        console.log('ğŸ”§ å¼ºåˆ¶æ¢è¡Œè„šæœ¬å·²åŠ è½½ï¼Œå¦‚æœä»£ç ä¸æ¢è¡Œè¯·ç‚¹å‡»"ğŸ”§ å¼ºåˆ¶æ¢è¡Œ"æŒ‰é’®');
    })();
  </script>

  <!-- ä¿®å¤ â‘  å¤åˆ¶æŒ‰é’® -->
  <script>
    async function copySel(sel, btn){
      try{
        const el = document.querySelector(sel);
        const t = el ? (el.value ?? el.textContent ?? '') : '';
        if(!t) throw new Error('æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹');
        if(navigator.clipboard?.writeText){
          await navigator.clipboard.writeText(t);
        }else{
          const ta=document.createElement('textarea');
          ta.value=t; ta.style.position='fixed'; ta.style.opacity='0';
          document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
        }
        if(btn){
          const old=btn.textContent; btn.textContent='âœ… å·²å¤åˆ¶';
          setTimeout(()=> btn.textContent=old, 1200);
        }
      }catch(e){
        alert('å¤åˆ¶å¤±è´¥ï¼š' + e.message);
      }
    }
  </script>

  <!-- ä¿®å¤ â‘¡ Prettier estree æŠ¥é”™å…œåº• -->
  <script>
    (function(){
      const needNoop =
        typeof window.prettier==='undefined' ||
        typeof window.prettier.format!=='function' ||
        !window.prettierPlugins;
      if(needNoop){
        window.prettier = window.prettier || {};
        window.prettier.format = function(code){ return String(code||''); };
        window.prettierPlugins = window.prettierPlugins || {};
        console.log('[noop] Prettier ç¼ºå°‘æ’ä»¶ â†’ å¯ç”¨å…œåº•ï¼ˆä»…åŸæ ·è¿”å›ï¼Œä¸æŠ¥é”™ï¼‰');
      }
    })();
  </script>
</body>
</html>
