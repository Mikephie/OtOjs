<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OtOjs · 解密前端（修复代码显示问题）</title>
  <style>
    :root {
      --bg:#0b0f14;--card:#0f1621;--muted:#9db1c7;--line:#1f2937;--line2:#223046;
      --text:#e6eef7;--btn:#152033;--ok:#10b981;--warn:#f59e0b;--err:#ef4444;--link:#67e8f9;
      --accent:#3b82f6;
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:var(--bg);
      color:var(--text)
    }

    a{color:var(--link)}

    .wrap{
      max-width:960px;
      margin:0 auto;
      padding:18px 14px 80px
    }

    h1{
      margin:10px 0 6px;
      font-size:20px
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px;
      margin:10px 0
    }

    label{
      font-size:12px;
      color:var(--muted);
      margin-right:6px
    }

    input,select,textarea{
      width:100%;
      background:#0f1a2b;
      color:var(--text);
      border:1px solid var(--line2);
      border-radius:10px;
      padding:10px;
      font-size:13px
    }

    textarea{
      min-height:160px;
      font-family:ui-monospace,Consolas,Menlo,monospace
    }

    .row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin:6px 0
    }

    .row>*{
      flex:1 1 200px
    }

    .row.compact>*{
      flex:initial
    }

    button{
      padding:6px 10px;
      border-radius:8px;
      border:1px solid #2b3b54;
      background:var(--btn);
      color:var(--text);
      cursor:pointer;
      font-weight:600;
      font-size:13px
    }

    button.ok{border-color:var(--ok)}
    button.warn{border-color:var(--warn)}
    button.err{border-color:var(--err)}

    /* 强力修复 pre 元素 - 多浏览器兼容 */
    pre{
      /* 强制换行 - 多浏览器兼容 */
      white-space: pre-wrap !important;       /* CSS3 标准 */
      white-space: -moz-pre-wrap !important;  /* Firefox */
      white-space: -pre-wrap !important;      /* Opera 4-6 */
      white-space: -o-pre-wrap !important;    /* Opera 7 */
      word-wrap: break-word !important;       /* IE 5.5+ */
      word-break: break-word !important;      /* 现代浏览器 */
      
      background:#0b1020;
      border:1px solid var(--line2);
      border-radius:10px;
      padding:10px;
      font-size:12px;
      font-family:ui-monospace,Consolas,Menlo,Monaco,'Courier New',monospace;
      line-height:1.4;
      max-height:380px;
      overflow:auto;
      tab-size:2;
      -moz-tab-size:2;
      
      /* 确保容器不会溢出 */
      max-width: 100% !important;
      overflow-wrap: break-word !important;
      hyphens: none !important;
    }

    /* 特别针对代码输出区域 */
    #codeOut, #outputRaw {
      /* 强制换行 - 关键修复 */
      white-space: pre-wrap !important;
      white-space: -moz-pre-wrap !important;
      white-space: -pre-wrap !important;
      white-space: -o-pre-wrap !important;
      word-wrap: break-word !important;
      word-break: break-word !important;
      overflow-wrap: break-word !important;
      
      background:#0b1020 !important;
      border:1px solid var(--line2) !important;
      border-radius:10px !important;
      padding:12px !important;
      font-size:12px !important;
      font-family:ui-monospace,Consolas,Menlo,Monaco,'Courier New',monospace !important;
      line-height:1.5 !important;
      max-height:450px !important;
      overflow:auto !important;
      tab-size:2 !important;
      -moz-tab-size:2 !important;
      color:var(--text) !important;
      max-width: 100% !important;
      
      /* 防止内容撑破容器 */
      box-sizing: border-box !important;
      width: 100% !important;
    }

    /* 空白占位符样式 */
    #codeOut:empty::before, #outputRaw:empty::before {
      content: attr(placeholder);
      color: var(--muted);
      font-style: italic;
    }

    small{color:var(--muted)}

    .bar-wrap{
      height:6px;
      background:#0b1020;
      border:1px solid var(--line2);
      border-radius:8px;
      overflow:hidden;
      margin-top:6px
    }

    .bar{
      height:100%;
      width:0%;
      background:var(--accent);
      transition:width 5s linear
    }

    .options{
      display:flex;
      gap:16px;
      font-size:12px;
      color:var(--muted);
      margin-top:6px
    }

    /* 隐藏原生文件输入 */
    #file {
      position:absolute !important;
      width:1px; 
      height:1px;
      opacity:0; 
      pointer-events:none;
    }

    /* 响应式优化 */
    @media (max-width: 768px) {
      .wrap {
        padding: 12px 8px 60px;
      }
      
      pre, #codeOut, #outputRaw {
        font-size: 11px !important;
        padding: 8px !important;
        max-height: 300px !important;
      }
      
      .options {
        flex-direction: column;
        gap: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>OtOjs · 解密前端（自动轮询 + 智能解密）</h1>

    <!-- 基础配置 -->
    <div class="card">
      <div class="row">
        <div style="flex:2">
          <label>REPO</label>
          <input id="repo" value="Mikephie/OtOjs" />
        </div>
        <div>
          <label>BRANCH</label>
          <input id="branch" value="main" />
        </div>
        <div>
          <label>Token（contents:rw）</label>
          <input id="token" type="password" placeholder="ghp_..." />
        </div>
      </div>
    </div>

    <!-- 输入 -->
    <div class="card">
      <small>把待解密脚本放到 <b>input.js</b> → Actions 自动跑 → 拉回输出文件并智能解密</small>
      <div class="row compact">
        <input type="file" id="file" accept=".js,.txt,.json" />
        <button onclick="pick()">文件</button>
        <input id="remoteUrl" placeholder="https:// 原始脚本 URL（支持 github/blob 自动转 raw）" />
        <button onclick="loadRemote()">远程</button>
        <button onclick="pasteFromClipboard()">粘贴</button>
        <button class="err" onclick="clrIn()">清空</button>
      </div>
      <textarea id="codeIn" placeholder="把待解密 JS 粘贴到这里，或用上方导入"></textarea>
      <div class="row compact">
        <button class="ok" onclick="submitInput()">提交</button>
        <button class="warn" onclick="startAutoPoll()">轮询</button>
        <button onclick="beautify()">美化</button>
        <button onclick="copySel('#codeOut', this)">复制</button>
        <button class="err" onclick="clrAll()">清空全部</button>
        <button onclick="forceWrapCode()" style="background: var(--accent); border-color: var(--accent);">强制换行</button>
      </div>
      <div class="options">
        <label><input type="checkbox" id="autoDecode" checked /> 自动智能解密</label>
        <label><input type="checkbox" id="autoBeautify" /> 自动美化（Prettier）</label>
        <label><input type="checkbox" id="autoResume" checked /> 后台恢复拉取</label>
      </div>
      <div id="status"><small>状态：就绪</small></div>
      <div class="bar-wrap" id="barWrap" style="display:none"><div class="bar" id="bar"></div></div>
      <pre id="codeOut" placeholder="结果将显示在这里"></pre>
    </div>

    <!-- 输出 -->
    <div class="card">
      <div class="row compact">
        <button onclick="loadOutputRaw('output/output.js')">拉取 output.js</button>
        <button onclick="loadOutputRaw('output/output.deob2.js')">拉取 deob2.js</button>
        <button onclick="copySel('#outputRaw', this)">复制结果</button>
        <button onclick="downloadOutput()">下载</button>
      </div>
      <pre id="outputRaw"></pre>
    </div>
  </div>

  <!-- JavaScript 修复函数 -->
  <script>
    // 强制代码换行函数
    function forceWrapCode() {
      const codeOut = document.getElementById('codeOut');
      const outputRaw = document.getElementById('outputRaw');
      
      [codeOut, outputRaw].forEach(element => {
        if (element && element.textContent) {
          let content = element.textContent;
          
          // 在常见的 JavaScript 分隔符后添加换行
          content = content
            // 在分号后换行（但避免在for循环中）
            .replace(/;(?![^(]*\))/g, ';\n')
            // 在大括号后换行
            .replace(/\{/g, '{\n')
            .replace(/\}/g, '\n}\n')
            // 在逗号后换行（在某些情况下）
            .replace(/,(?=\s*[a-zA-Z_$])/g, ',\n')
            // 在 eval() 或 function() 关键字前换行
            .replace(/(eval\(|function\()/g, '\n$1')
            // 清理多余的换行
            .replace(/\n{3,}/g, '\n\n')
            .trim();
          
          element.textContent = content;
          
          // 强制重新应用CSS样式
          element.style.whiteSpace = 'pre-wrap';
          element.style.wordWrap = 'break-word';
          element.style.wordBreak = 'break-word';
          element.style.overflowWrap = 'break-word';
        }
      });
      
      // 更新状态
      document.getElementById('status').innerHTML = '<small>状态：已强制换行处理</small>';
    }
    
    // 复制函数
    async function copySel(sel, btn){
      try{
        const el = document.querySelector(sel);
        const t = el ? (el.value ?? el.textContent ?? '') : '';
        if(!t) throw new Error('没有可复制的内容');
        if(navigator.clipboard?.writeText){
          await navigator.clipboard.writeText(t);
        }else{
          const ta=document.createElement('textarea');
          ta.value=t; ta.style.position='fixed'; ta.style.opacity='0';
          document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
        }
        if(btn){
          const old=btn.textContent; btn.textContent='✅ 已复制';
          setTimeout(()=> btn.textContent=old, 1200);
        }
      }catch(e){
        alert('复制失败：' + e.message);
      }
    }
    
    // 模拟一些功能以便测试
    function pick() { alert('文件选择功能'); }
    function loadRemote() { alert('远程加载功能'); }
    function pasteFromClipboard() { alert('粘贴功能'); }
    function clrIn() { document.getElementById('codeIn').value = ''; }
    function submitInput() { alert('提交功能'); }
    function startAutoPoll() { alert('轮询功能'); }
    function beautify() { alert('美化功能'); }
    function clrAll() { 
      document.getElementById('codeIn').value = '';
      document.getElementById('codeOut').textContent = '';
      document.getElementById('outputRaw').textContent = '';
    }
    function loadOutputRaw(path) { alert('拉取: ' + path); }
    function downloadOutput() { alert('下载功能'); }
    
    // 测试数据 - 模拟混淆代码
    document.addEventListener('DOMContentLoaded', function() {
      const testCode = `eval(function(p,a,c,k,e,d){e=function(c){return(c<a?'':e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--){d[e(c)]=k[c]||e(c)}k=[function(e){return d[e]}];e=function(){return'\\\\w+'};c=1};while(c--){if(k[c]){p=p.replace(new RegExp('\\\\b'+e(c)+'\\\\b','g'),k[c])}}return p}('5J(c){5I(c<a?'':e(5S(c/a)))+((c=c%a)>35?5N.5U(c+29):c.5O(36))};5K(!''.5L(/*^/,5N)){5M(c--){d[e(c)]=k[c]||e(c)}k=[5J(e){5I d[e]}];e=5J(){5I'\\\\w+'};c=1};5M(c--){5K(k[c]){p=p.5L(5R 5P('\\\\/\\\\/\\\\b'+e(c)+'\\\\/\\\\b','g'),k[c])}}5I p}('5Q(J,p,a,c,k,e,d){e=2Q(c){2P(c<a?'':e(2S(c/a)))+((c=c%a)>35?2R.3T(c+29):c.2V(36))};2U(!''.2X(/^/,2R)){2Y(c--){d[e(c)]=k[c]||e(c)}k=[2Q(e){2P d[e]}];e=2Q(){2P'\\\\\\\\w+'};c=1};2Y(c--){2U(k[c]){p=p.2X(2W 3S('\\\\\\\\b'+e(c)+'\\\\\\\\b','g'),k[c])}}2P p}('S.M.y.10.1x.1j.1u.1k.1M.'a T='23';a 1e=1B;a 1o=1;a 9=D.1m($1H.s);a 1n=$1p.2;a $=1P';
      document.getElementById('codeIn').value = testCode;
      
      // 自动触发到输出区域
      setTimeout(() => {
        document.getElementById('codeOut').textContent = testCode;
      }, 100);
    });
  </script>

  <!-- Prettier 兜底 -->
  <script>
    (function(){
      const needNoop =
        typeof window.prettier==='undefined' ||
        typeof window.prettier.format!=='function' ||
        !window.prettierPlugins;
      if(needNoop){
        window.prettier = window.prettier || {};
        window.prettier.format = function(code){ return String(code||''); };
        window.prettierPlugins = window.prettierPlugins || {};
        console.log('[noop] Prettier 缺少插件 → 启用兜底（仅原样返回，不报错）');
      }
    })();
  </script>
</body>
</html>
