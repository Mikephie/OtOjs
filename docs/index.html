<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OtOjs · 解密前端（自动轮询 + 智能解密）</title>
  <link rel="stylesheet" href="style.css" />
  <style>pre{white-space:pre-wrap;word-break:break-word}</style>
</head>
<body>
  <div class="wrap">
    <h1>OtOjs · 解密前端（自动轮询 + 智能解密）</h1>

    <!-- 基础配置 -->
    <div class="card">
      <div class="row">
        <div style="flex:2">
          <label>REPO</label>
          <input id="repo" value="Mikephie/OtOjs" />
        </div>
        <div>
          <label>BRANCH</label>
          <input id="branch" value="main" />
        </div>
        <div>
          <label>Token（contents:rw）</label>
          <input id="token" type="password" placeholder="ghp_..." />
        </div>
      </div>
    </div>

    <!-- 输入 -->
    <div class="card">
      <small>把待解密脚本放到 <b>input.js</b> → Actions 自动跑 → 拉回输出文件并智能解密</small>
      <div class="row compact">
        <input type="file" id="file" accept=".js,.txt,.json" />
        <button onclick="pick()">文件</button>
        <input id="remoteUrl" placeholder="https:// 原始脚本 URL（支持 github/blob 自动转 raw）" />
        <button onclick="loadRemote()">远程</button>
        <button onclick="pasteFromClipboard()">粘贴</button>
        <button class="err" onclick="clrIn()">清空</button>
      </div>
      <textarea id="codeIn" placeholder="把待解密 JS 粘贴到这里，或用上方导入"></textarea>
      <div class="row compact">
        <button class="ok" onclick="submitInput()">提交</button>
        <button class="warn" onclick="startAutoPoll()">轮询</button>
        <button onclick="beautify()">美化</button>
        <button onclick="copySel('#codeOut', this)">复制</button>
        <button class="err" onclick="clrAll()">清空全部</button>
      </div>
      <div class="options">
        <label><input type="checkbox" id="autoDecode" checked /> 自动智能解密</label>
        <label><input type="checkbox" id="autoBeautify" /> 自动美化（Prettier）</label>
        <label><input type="checkbox" id="autoResume" checked /> 后台恢复拉取</label>
      </div>
      <div id="status"><small>状态：就绪</small></div>
      <div class="bar-wrap" id="barWrap" style="display:none"><div class="bar" id="bar"></div></div>
      <pre id="codeOut" style="white-space:pre-wrap;word-break:break-word" placeholder="结果将显示在这里"></pre>
    </div>

    <!-- 输出 -->
    <div class="card">
      <div class="row compact">
        <button onclick="loadOutputRaw('output/output.js')">拉取 output.js</button>
        <button onclick="loadOutputRaw('output/output.deob2.js')">拉取 deob2.js</button>
        <button onclick="copySel('#outputRaw', this)">复制结果</button>
        <button onclick="downloadOutput()">下载</button>
      </div>
      <pre id="outputRaw" style="white-space:pre-wrap;word-break:break-word"></pre>
    </div>
  </div>

  <!-- 先插件，再主逻辑 -->
  <script src="decode-all.js"></script>
  <script src="app.js"></script>

  <!-- 复制按钮（全局） -->
  <script>
    async function copySel(sel, btn){
      try{
        const el = document.querySelector(sel);
        const t = el ? (el.value ?? el.textContent ?? '') : '';
        if (navigator.clipboard?.writeText) await navigator.clipboard.writeText(t);
        else { const ta=document.createElement('textarea'); ta.value=t; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); }
        const old=btn.textContent; btn.textContent='✅ 已复制'; setTimeout(()=>btn.textContent=old,1200);
      }catch(e){ alert('复制失败：'+e.message); }
    }
  </script>

  <!-- Prettier：显式加载 estree + 重写 beautify 使用两个插件 -->
  <script src="https://unpkg.com/prettier@3.2.5/standalone.js"></script>
  <script src="https://unpkg.com/prettier@3.2.5/plugins/babel.js"></script>
  <script src="https://unpkg.com/prettier@3.2.5/plugins/estree.js"></script>
  <script>
    async function beautify(){
      let s=document.querySelector('#codeOut').textContent || document.querySelector('#codeIn').value || '';
      if(!s.trim()){ document.getElementById('status').innerHTML='<small>无待美化内容</small>'; return; }
      try{
        const out = prettier.format(String(s), {
          parser: 'babel',
          plugins: [prettierPlugins.babel, prettierPlugins.estree]
        });
        document.querySelector('#codeOut').textContent = out;
        document.getElementById('status').innerHTML = '<small>已用 Prettier 美化</small>';
      }catch(e){
        document.getElementById('status').innerHTML = '<small>Prettier 失败：'+e.message+'</small>';
      }
    }
  </script>

  <!-- 轻量防卡排版：展开 \"\\n\"、JSON 尝试、结构字符缩进，长度>200k跳过 -->
  <script>
    const FORMAT_MAX = 200000;   // 超过则不处理，避免卡顿
    const BATCH_DELAY = 120;     // 防抖

    function expandEscapedSafe(s){
      if (typeof s !== 'string' || s.length > FORMAT_MAX) return s;
      if (!/\\[nrt"\\]/.test(s)) return s;
      try {
        const wrapped = '"' + s.replace(/\\/g,'\\\\').replace(/"/g,'\\"') + '"';
        return JSON.parse(wrapped);
      } catch {
        return s.replace(/\\r\\n/g,'\n').replace(/\\n/g,'\n').replace(/\\t/g,'\t').replace(/\\r/g,'\r').replace(/\\"/g,'"').replace(/\\\\/g,'\\');
      }
    }
    function tryPrettyJSONSafe(s){
      if (typeof s!=='string' || s.length > FORMAT_MAX) return null;
      try { return JSON.stringify(JSON.parse(s), null, 2); } catch { return null; }
    }
    function simplePrettySafe(s){
      if (typeof s!=='string' || s.length > FORMAT_MAX) return s;
      let out='', indent=0, inStr=false, quote='', esc=false;
      const tab=()=> '  '.repeat(Math.max(0,indent));
      for(let i=0;i<s.length;i++){
        const ch=s[i];
        if(inStr){
          out+=ch;
          if(esc) esc=false;
          else if(ch==='\\') esc=true;
          else if(ch===quote) inStr=false;
          continue;
        }
        if(ch==='\"'||ch==="'"||ch==='`'){ inStr=true; quote=ch; esc=false; out+=ch; continue; }
        if(ch==='{'||ch==='['){ out+=ch+'\n'; indent++; out+=tab(); continue; }
        if(ch==='}'||ch===']'){ out+='\n'; indent--; out+=tab()+ch; continue; }
        if(ch===','||ch===';'){ out+=ch+'\n'+tab(); continue; }
        if(ch==='\n'){ out+='\n'+tab(); continue; }
        out+=ch;
      }
      return out.replace(/\n{3,}/g,'\n\n').trim()+'\n';
    }
    function autoFormatSafe(raw){
      if (!raw || typeof raw!=='string') return raw;
      const expanded = expandEscapedSafe(raw);
      const j = tryPrettyJSONSafe(expanded);
      return j || simplePrettySafe(expanded);
    }
    function runIdle(fn){ window.requestIdleCallback ? requestIdleCallback(()=>setTimeout(fn,0),{timeout:300}) : setTimeout(fn,0); }
    function attachReflowSafe(preId){
      const el=document.getElementById(preId); if(!el) return;
      let pending=false, t=null;
      const schedule=()=>{
        if(t) clearTimeout(t);
        t=setTimeout(()=>{
          if(pending) return;
          pending=true;
          runIdle(()=>{
            try{
              const raw=el.textContent||'';
              if(raw.length>FORMAT_MAX){ pending=false; return; }
              const pretty=autoFormatSafe(raw);
              if(pretty && pretty!==raw) el.textContent=pretty;
            }finally{ pending=false; }
          });
        }, BATCH_DELAY);
      };
      schedule();
      new MutationObserver(schedule).observe(el,{childList:true,subtree:true,characterData:true});
    }
    window.addEventListener('load', ()=>{
      attachReflowSafe('codeOut');
      attachReflowSafe('outputRaw');
    });
  </script>
</body>
</html>