<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OtOjs Â· å‰ç«¯æ§åˆ¶å° + ç§‘æŠ€è§£ç å™¨</title>
  <meta name="description" content="OtOjs å‰ç«¯ï¼šGitHub å¿«æ·æ“ä½œ + ç§‘æŠ€è§£ç å™¨ï¼ˆæ–‡ä»¶/ç²˜è´´/è¿œç¨‹åŠ è½½ã€å¼€å§‹è§£å¯†ã€è·å–ç»“æœã€å¤åˆ¶ã€ä»£ç ç¾åŒ–ã€æ¸…é™¤ï¼‰ã€‚" />
  <style>
    :root{
      --bg: radial-gradient(1200px 800px at 10% 0%, #0ea5e95c 0%, transparent 50%),
            radial-gradient(900px 700px at 90% 20%, #22c55e40 0%, transparent 60%),
            linear-gradient(180deg,#0b0f14 0%, #0b0f14 60%, #0b0f14 100%);
      --card: rgba(255,255,255,.06);
      --card-2: rgba(255,255,255,.08);
      --text: #e6eef7;
      --muted: #9db1c7;
      --accent: #6ee7ff;
      --accent-2:#7c3aed;
      --ok: #10b981;
      --warn:#f59e0b;
      --err:#ef4444;
      --radius: 20px;
      --shadow: 0 10px 30px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.06);
      --glass: blur(8px) saturate(120%);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; padding:0; color:var(--text); background:var(--bg); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";}
    a{color:var(--accent)}
    .container{max-width:1200px; margin:0 auto; padding:28px 16px 120px}
    header{display:flex; align-items:center; gap:14px; margin-bottom:18px}
    .logo{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,#22d3ee, #a78bfa); box-shadow: 0 8px 24px rgba(124,58,237,.35), inset 0 1px 0 rgba(255,255,255,.3)}
    .title h1{margin:0;font-size:26px;letter-spacing:.2px}
    .title p{margin:2px 0 0;color:var(--muted);font-size:13px}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{grid-column:span 12; background:var(--card); border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); box-shadow: var(--shadow); backdrop-filter: var(--glass)}
    @media(min-width:900px){.span-5{grid-column:span 5}.span-7{grid-column:span 7}.span-6{grid-column:span 6}.span-4{grid-column:span 4}.span-8{grid-column:span 8}.span-12{grid-column:span 12}}
    .card h2{margin:0; padding:16px 16px 8px; font-size:16px; font-weight:700}
    .card .sub{color:var(--muted); font-size:12px; padding:0 16px 12px}
    .section{padding:12px 16px 16px}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .field{display:flex;gap:8px; width:100%; align-items:center}
    .field input[type="text"], .field input[type="url"], .field textarea{flex:1; width:100%; background:var(--card-2); border:1px solid rgba(255,255,255,.08); color:var(--text); padding:10px 12px; border-radius:12px; outline:none}
    textarea{min-height:140px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px}
    .btn{padding:10px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:linear-gradient(180deg, rgba(255,255,255,.1), rgba(255,255,255,.05)); color:var(--text); cursor:pointer; font-weight:700; font-size:13px; letter-spacing:.2px; box-shadow: var(--shadow); backdrop-filter: var(--glass)}
    .btn:hover{transform: translateY(-1px)} .btn:active{transform: translateY(0)} .btn.ok{border-color: rgba(16,185,129,.35)} .btn.warn{border-color: rgba(245,158,11,.35)} .btn.err{border-color: rgba(239,68,68,.35)} .btn.ghost{background:transparent}
    .kbd{font: 12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas; padding:2px 6px; border-radius:6px; background:#0b1020; border:1px solid rgba(255,255,255,.08)}
    .link-list{display:grid;grid-template-columns:repeat(2,1fr); gap:8px}
    .link-item{display:flex;gap:10px;align-items:center; padding:10px 12px; border-radius:10px; background:var(--card-2); border:1px solid rgba(255,255,255,.06)}
    .dot{width:8px;height:8px;border-radius:50%; background:var(--accent)}
    .code{white-space:pre-wrap; background:#0b1020; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:12px; font-size:12px; overflow:auto}
    footer{margin-top:20px; color:var(--muted); font-size:12px; text-align:center}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid rgba(255,255,255,.12); border-radius:999px; background:var(--card-2)}

    /* ä¸Šä¼ æ‹–æ‹½æ¡† */
    .drop{border:2px dashed rgba(255,255,255,.25); border-radius:16px; padding:24px; text-align:center; color:var(--muted)}
    .drop.drag{border-color: var(--accent); color: var(--accent)}

    /* ä¸»é¢˜åˆ‡æ¢ï¼ˆæµ…è‰²ï¼‰ */
    :root[data-theme="light"]{--bg: radial-gradient(1200px 800px at 10% 0%, #22d3ee33 0%, transparent 50%), radial-gradient(900px 700px at 90% 20%, #a78bfa2e 0%, transparent 60%), linear-gradient(180deg,#f7fafc 0%, #f4f7fb 60%, #eef2f7 100%); --card: rgba(0,0,0,.04); --card-2: rgba(0,0,0,.05); --text:#0b1220; --muted:#4b5563; --accent:#2563eb; --accent-2:#7c3aed; --ok:#059669; --warn:#b45309; --err:#dc2626; --shadow: 0 6px 20px rgba(0,0,0,.12), inset 0 1px 0 rgba(255,255,255,.6)}
    .theme-btn{margin-left:auto;padding:8px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.06));color:var(--text);cursor:pointer;font-weight:600;box-shadow:var(--shadow);backdrop-filter:var(--glass)}
    :root[data-theme="light"] .theme-btn{border-color:rgba(0,0,0,.08);background:linear-gradient(180deg,rgba(255,255,255,.8),rgba(255,255,255,.5))}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo" aria-hidden="true"></div>
      <div class="title">
        <h1>OtOjs Â· å‰ç«¯æ§åˆ¶å° + ç§‘æŠ€è§£ç å™¨</h1>
        <p>é¢å‘ <span class="pill"><span class="dot"></span>GitHub</span> ä¸æœ¬åœ°/è¿œç¨‹ä»£ç çš„è½»é‡å·¥å…·é¡µã€‚</p>
      </div>
      <button class="theme-btn" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ—</button>
      <button class="theme-btn" onclick="resetTheme()" title="æ¢å¤è·Ÿéšç³»ç»Ÿä¸»é¢˜">ğŸ”„</button>
    </header>

    <div class="grid" id="app">
      <!-- å¿«æ·å…¥å£ -->
      <section class="card span-12">
        <h2>âš¡ å¸¸ç”¨å¿«æ·å…¥å£</h2>
        <p class="sub">ä¸€é”®ç›´è¾¾ä»“åº“å¸¸ç”¨é¡µé¢ä¸æ¨¡æ¿ã€‚</p>
        <div class="section">
          <div class="link-list">
            <div class="link-item"><span class="dot"></span><a id="linkRepo" target="_blank">æ‰“å¼€ä»“åº“</a></div>
            <div class="link-item"><span class="dot"></span><a id="linkActions" target="_blank">æ‰“å¼€ Actions</a></div>
            <div class="link-item"><span class="dot"></span><a id="linkIssues" target="_blank">Issues</a></div>
            <div class="link-item"><span class="dot"></span><a id="linkNewIssueWeb" target="_blank">æ–°å»º Issue Â· [Webè§£å¯†è¯·æ±‚]</a></div>
            <div class="link-item"><span class="dot"></span><a id="linkInputBlob" target="_blank">æŸ¥çœ‹ input.js (Blob)</a></div>
            <div class="link-item"><span class="dot"></span><a id="linkOutputBlob" target="_blank">æŸ¥çœ‹ output.js (Blob)</a></div>
            <div class="link-item"><span class="dot"></span><a id="linkInputEdit" target="_blank">ç¼–è¾‘ input.js</a></div>
            <div class="link-item"><span class="dot"></span><a id="linkOutputRaw" target="_blank">æŸ¥çœ‹ output.js (Raw)</a></div>
          </div>
        </div>
      </section>

      <!-- ä»“åº“è®¾ç½® + Raw ç”Ÿæˆå™¨ -->
      <section class="card span-7">
        <h2>â‘  ä»“åº“è®¾ç½®</h2>
        <p class="sub">ç”¨äºç”Ÿæˆ Raw é“¾æ¥ã€è·³è½¬åˆ°ç¼–è¾‘é¡µã€æ‹¼æ¥ API å‘½ä»¤ç­‰ã€‚</p>
        <div class="section">
          <div class="field">
            <label class="kbd">REPO</label>
            <input id="repo" type="text" placeholder="ä¾‹å¦‚ï¼šMikephie/OtOjs" value="Mikephie/OtOjs" />
            <button class="btn" onclick="saveRepo()">ä¿å­˜</button>
          </div>
          <div class="field" style="margin-top:8px">
            <label class="kbd">BRANCH</label>
            <input id="branch" type="text" placeholder="main / master / å…¶å®ƒåˆ†æ”¯" value="main" />
            <button class="btn" onclick="saveBranch()">ä¿å­˜</button>
          </div>
        </div>
        <div class="section">
          <div class="field">
            <input id="relPath" type="text" placeholder="ä¾‹å¦‚ï¼šinput.js æˆ– src/xxx.js" value="input.js" />
            <button class="btn" onclick="genRaw()">ç”Ÿæˆ Raw/API</button>
            <button class="btn" onclick="copyFrom('#rawOut', this)">å¤åˆ¶</button>
          </div>
          <div id="rawOut" class="code" style="margin-top:10px"></div>
        </div>
      </section>

      <section class="card span-5">
        <h2>â‘¡ GitHub API å‘½ä»¤</h2>
        <p class="sub">æ›¿æ¢ <code>YOUR_TOKEN</code> åå¯ç›´æ¥ PUT/GET ä»“åº“å†…å®¹ï¼ˆç§åº“é€‚ç”¨ï¼‰ã€‚</p>
        <div class="section">
          <div class="field"><input id="apiPath" type="text" value="input.js" /></div>
          <div class="field"><input id="apiMsg" type="text" value="update: input.js via OtOjs UI" /></div>
          <div class="row" style="margin:8px 0">
            <button class="btn" onclick="genCurl('PUT')">ç”Ÿæˆ curl (PUT)</button>
            <button class="btn warn" onclick="genCurl('GET')">ç”Ÿæˆ curl (GET)</button>
            <button class="btn" onclick="copyFrom('#curlOut', this)">å¤åˆ¶</button>
          </div>
          <div class="row" style="margin:8px 0">
            <input id="apiToken" type="password" placeholder="ghp_xxx ä¸ªäººè®¿é—®ä»¤ç‰Œ (repo contents: read & write)" />
            <button class="btn ok" onclick="apiPut()">ç›´æ¥ä¸Šä¼  (PUT)</button>
            <button class="btn" onclick="apiGet()">è¯»å– (GET)</button>
          </div>
          <div id="curlOut" class="code"></div>
        </div>
      </section>

      <!-- ç§‘æŠ€è§£ç å™¨ï¼šæ–‡ä»¶è¾“å…¥ & ä»£ç è¾“å…¥ & æ“ä½œæŒ‰é’® -->
      <section class="card span-12">
        <h2>ğŸ§ª ç§‘æŠ€è§£ç å™¨ v7.0</h2>
        <p class="sub">æ”¯æŒ æ–‡ä»¶è¾“å…¥ / è¿œç¨‹åŠ è½½ / ç²˜è´´ä»£ç ï¼›æä¾› å¼€å§‹è§£å¯† / è·å–ç»“æœ / å¤åˆ¶ / ä»£ç ç¾åŒ– / æ¸…é™¤ã€‚</p>
        <div class="section">
          <!-- æ–‡ä»¶è¾“å…¥ -->
          <div id="drop" class="drop">
            ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤ï¼ˆæ”¯æŒ .js .txt .jsonï¼‰
          </div>
          <div class="row" style="margin-top:8px">
            <input type="file" id="file" accept=".js,.txt,.json" />
            <button class="btn" onclick="pickFile()">é€‰æ‹©æ–‡ä»¶</button>
            <input id="remoteUrl" type="url" placeholder="https:// è¿œç¨‹è„šæœ¬åœ°å€" />
            <button class="btn" onclick="loadRemote()">è¿œç¨‹åŠ è½½</button>
            <button class="btn" onclick="pasteFromClipboard()">ç²˜è´´æ¿</button>
            <button class="btn err" onclick="clearInput()">æ¸…ç©ºè¾“å…¥</button>
          </div>
        </div>
        <div class="section">
          <!-- ä»£ç è¾“å…¥ -->
          <h3 style="margin:0 0 8px 0;font-size:14px">ä»£ç è¾“å…¥</h3>
          <div class="field"><textarea id="codeIn" placeholder="è¯·ç²˜è´´éœ€è¦è§£å¯†çš„ JavaScript ä»£ç ..."></textarea></div>
        </div>
        <div class="section">
          <!-- æ“ä½œæŒ‰é’® -->
          <div class="row">
            <button class="btn ok" onclick="startDecode()">å¼€å§‹è§£å¯†</button>
            <button class="btn" onclick="getResult()">è·å–ç»“æœ</button>
            <button class="btn" onclick="copyFrom('#codeOut', this)">å¤åˆ¶</button>
            <button class="btn" onclick="beautify()">ä»£ç ç¾åŒ–</button>
            <button class="btn err" onclick="clearAll()">æ¸…é™¤</button>
          </div>
          <pre id="codeOut" class="code" style="margin-top:10px; min-height:160px"></pre>
        </div>
      </section>

      <!-- output.js å¿«é€Ÿé¢„è§ˆ -->
      <section class="card span-12">
        <h2>â‘¢ output.js å¿«é€Ÿé¢„è§ˆ</h2>
        <p class="sub">ä» Raw æ‹‰å–ä»…åšå¿«é€ŸæŸ¥çœ‹ã€‚</p>
        <div class="section">
          <div class="row">
            <button class="btn" onclick="loadOutput()">æ‹‰å–æœ€æ–°è¾“å‡º</button>
            <button class="btn" onclick="downloadOutput()">ä¸‹è½½ output.js</button>
            <button class="btn" onclick="copyFrom('#outputView', this)">å¤åˆ¶</button>
            <small style="color:var(--muted)">å¦‚ä¸ºç§åº“è¯·ç™»å½• GitHub æˆ–æ”¹ç”¨ API + Tokenã€‚</small>
          </div>
          <pre id="outputView" class="code" style="margin-top:10px; max-height:360px"></pre>
        </div>
      </section>
    </div>

    <footer>
      <p>OtOjs Frontend Â· å•æ–‡ä»¶éƒ¨ç½²ã€‚æ”¯æŒç›´æ¥æ”¾åœ¨ <span class="kbd">docs/</span> æˆ– GitHub Pagesã€‚</p>
    </footer>
  </div>

  <script>
    // --- Theme helpers ---
    function watchSystemTheme(){
      if(!window.matchMedia) return; const mq = window.matchMedia('(prefers-color-scheme: light)');
      mq.addEventListener?.('change', (e)=>{ if(!localStorage.getItem('theme')){ applyTheme(e.matches ? 'light' : 'dark'); toast('å·²è·Ÿéšç³»ç»Ÿåˆ‡æ¢ä¸»é¢˜'); } });
    }
    function applyTheme(theme){
      let t = theme || localStorage.getItem('theme'); if(!t){ const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches; t = prefersLight ? 'light' : 'dark'; }
      document.documentElement.setAttribute('data-theme', t === 'light' ? 'light' : 'dark'); localStorage.setItem('theme', t);
      const btns = document.querySelectorAll('.theme-btn'); if(btns[0]) btns[0].textContent = (t === 'light') ? 'ğŸŒ' : 'ğŸŒ™';
    }
    function toggleTheme(){ const cur = localStorage.getItem('theme') || 'dark'; applyTheme(cur === 'light' ? 'dark' : 'light'); toast(`å·²åˆ‡æ¢ä¸º${(localStorage.getItem('theme')==='light')?'æµ…è‰²':'æ·±è‰²'}ä¸»é¢˜`); }
    function resetTheme(){ localStorage.removeItem('theme'); applyTheme(); toast('å·²æ¢å¤è·Ÿéšç³»ç»Ÿä¸»é¢˜'); }

    // --- State helpers ---
    const $ = (sel)=> document.querySelector(sel);
    const st = { get repo(){ return localStorage.getItem('repo') || 'Mikephie/OtOjs' }, set repo(v){ localStorage.setItem('repo', v) }, get branch(){ return localStorage.getItem('branch') || 'main' }, set branch(v){ localStorage.setItem('branch', v) } }

    function initLinks(){
      const base = `https://github.com/${st.repo}`; const blob = `${base}/blob/${st.branch}`; const raw  = `https://raw.githubusercontent.com/${st.repo}/${st.branch}`;
      $('#linkRepo').href = base; $('#linkActions').href = `${base}/actions`; $('#linkIssues').href = `${base}/issues`;
      $('#linkNewIssueWeb').href = `${base}/issues/new?title=${encodeURIComponent('[Webè§£å¯†è¯·æ±‚]')}&labels=${encodeURIComponent('web-decode')}`;
      $('#linkInputBlob').href = `${blob}/input.js`; $('#linkOutputBlob').href = `${blob}/output.js`;
      $('#linkInputEdit').href = `${blob}/input.js`; $('#linkOutputRaw').href = `${raw}/output.js`;
    }
    function saveRepo(){ st.repo = $('#repo').value.trim(); initLinks(); toast('å·²ä¿å­˜ REPO') }
    function saveBranch(){ st.branch = $('#branch').value.trim(); initLinks(); toast('å·²ä¿å­˜ BRANCH') }

    // --- Raw link generator ---
    function genRaw(){ const rel = $('#relPath').value.trim().replace(/^\/+/, ''); const raw = `https://raw.githubusercontent.com/${st.repo}/${st.branch}/${rel}`; const api = `https://api.github.com/repos/${st.repo}/contents/${rel}?ref=${encodeURIComponent(st.branch)}`; $('#rawOut').textContent = [`# å…¬å…±ç›´é“¾ (Raw)\n${raw}`, `\n# ç§åº“ / éœ€ token çš„ API è¯»å–\n${api}`].join('\n'); }

    // --- GitHub API curl helper ---
    async function genCurl(method){ const filePath = $('#apiPath').value.trim().replace(/^\/+/, ''); const msg = $('#apiMsg').value.trim(); const api = `https://api.github.com/repos/${st.repo}/contents/${filePath}`; if(method==='GET'){ $('#curlOut').textContent = `curl -H \"Authorization: Bearer YOUR_TOKEN\" \n  -H \"Accept: application/vnd.github+json\" \n  \"${api}?ref=${st.branch}\"`; return; } try{ let sha=''; const res = await fetch(`${api}?ref=${st.branch}`); if(res.ok){ const j = await res.json(); sha = j.sha || ''; } const contentSource = ($('#codeIn') && $('#codeIn').value.trim()) ? $('#codeIn').value : '/* replace with your JS */'; const payload = { message: msg, content: btoa(unescape(encodeURIComponent(contentSource))), branch: st.branch, sha: sha || undefined }; const pretty = JSON.stringify(payload, null, 2); const curl = [`curl -X PUT \\\`, `  -H \"Authorization: Bearer YOUR_TOKEN\" \\\`, `  -H \"Accept: application/vnd.github+json\" \\\`, `  ${JSON.stringify(api)} \\\`, `  -d ${JSON.stringify(pretty)}`].join('\n'); $('#curlOut').textContent = curl; }catch(e){ $('#curlOut').textContent = '# ç”Ÿæˆå¤±è´¥ï¼š' + e.message; } }

    // --- Direct GitHub API via Token ---
    function ghHeaders(){ const t = $('#apiToken').value.trim(); return { 'Authorization': `Bearer ${t}`, 'Accept': 'application/vnd.github+json' } }
    async function apiGet(){ const path = $('#apiPath').value.trim().replace(/^\/+/, ''); const api = `https://api.github.com/repos/${st.repo}/contents/${path}?ref=${st.branch}`; try{ const res = await fetch(api,{headers:ghHeaders()}); if(!res.ok) throw new Error(res.status+' '+res.statusText); const j = await res.json(); const content = j.content ? decodeURIComponent(escape(atob(j.content))) : ''; $('#codeOut').textContent = content; toast('å·²è¯»å–ï¼š'+path); }catch(e){ toast('è¯»å–å¤±è´¥ï¼š'+e.message) } }
    async function apiPut(){ const path = $('#apiPath').value.trim().replace(/^\/+/, ''); const msg = $('#apiMsg').value.trim() || 'update via UI'; const api = `https://api.github.com/repos/${st.repo}/contents/${path}`; const code = ($('#codeIn') && $('#codeIn').value.trim()) ? $('#codeIn').value : ($('#codeOut').textContent||''); try{ let sha=''; const check = await fetch(`${api}?ref=${st.branch}`,{headers:ghHeaders()}); if(check.ok){ const j = await check.json(); sha = j.sha || ''; }
      const body = { message: msg, content: btoa(unescape(encodeURIComponent(code))), branch: st.branch, sha: sha || undefined };
      const res = await fetch(api,{ method:'PUT', headers: { 'Content-Type':'application/json', ...ghHeaders() }, body: JSON.stringify(body) });
      if(!res.ok) throw new Error(res.status+' '+res.statusText);
      toast('ä¸Šä¼ æˆåŠŸ (PUT)');
    }catch(e){ toast('ä¸Šä¼ å¤±è´¥ï¼š'+e.message) } }/contents/${filePath}`; if(method==='GET'){ $('#curlOut').textContent = `curl -H "Authorization: Bearer YOUR_TOKEN" \n  -H "Accept: application/vnd.github+json" \n  \"${api}?ref=${st.branch}\"`; return; } try{ let sha=''; const res = await fetch(`${api}?ref=${st.branch}`); if(res.ok){ const j = await res.json(); sha = j.sha || ''; } const contentSource = ($('#codeIn') && $('#codeIn').value.trim()) ? $('#codeIn').value : '/* replace with your JS */'; const payload = { message: msg, content: btoa(unescape(encodeURIComponent(contentSource))), branch: st.branch, sha: sha || undefined }; const pretty = JSON.stringify(payload, null, 2); const curl = [`curl -X PUT \\`, `  -H "Authorization: Bearer YOUR_TOKEN" \\`, `  -H "Accept: application/vnd.github+json" \\`, `  ${JSON.stringify(api)} \\`, `  -d ${JSON.stringify(pretty)}`].join('\n'); $('#curlOut').textContent = curl; }catch(e){ $('#curlOut').textContent = '# ç”Ÿæˆå¤±è´¥ï¼š' + e.message; } }

    // --- Decoder I/O helpers ---
    const drop = ()=> $('#drop');
    function pickFile(){ $('#file').click(); }
    function readFile(f){ return new Promise((resolve,reject)=>{ const r = new FileReader(); r.onload = ()=> resolve(r.result); r.onerror = reject; r.readAsText(f,'utf-8'); }); }
    function attachDnd(){ const box = drop(); box.addEventListener('dragover',e=>{e.preventDefault(); box.classList.add('drag')}); box.addEventListener('dragleave',()=>box.classList.remove('drag')); box.addEventListener('drop', async e=>{e.preventDefault(); box.classList.remove('drag'); const f = e.dataTransfer.files?.[0]; if(f){ const txt = await readFile(f); $('#codeIn').value = txt; toast('å·²è½½å…¥æ–‡ä»¶ï¼š'+f.name); } }); }
    document.addEventListener('change', async (e)=>{ if(e.target && e.target.id==='file' && e.target.files[0]){ const f=e.target.files[0]; const txt = await readFile(f); $('#codeIn').value = txt; toast('å·²è½½å…¥æ–‡ä»¶ï¼š'+f.name); }});
    async function loadRemote(){ const u = $('#remoteUrl').value.trim(); if(!u){ toast('è¯·è¾“å…¥è¿œç¨‹ URL'); return } try{ const res = await fetch(u); const t = await res.text(); $('#codeIn').value = t; toast('å·²åŠ è½½è¿œç¨‹è„šæœ¬'); } catch(e){ toast('åŠ è½½å¤±è´¥ï¼š'+e.message) } }
    async function pasteFromClipboard(){ try{ const t = await navigator.clipboard.readText(); $('#codeIn').value = t; toast('å·²ç²˜è´´'); }catch(e){ toast('è¯»å–å‰ªè´´æ¿å¤±è´¥ï¼š'+e.message) } }
    function clearInput(){ $('#codeIn').value=''; toast('å·²æ¸…ç©ºè¾“å…¥'); }

    // --- Decoder actions (å ä½å®ç°ï¼Œå¯æ›¿æ¢ä¸ºçœŸå®è§£å¯†é€»è¾‘) ---
    function startDecode(){ const src = $('#codeIn').value || ''; if(!src){ toast('æ— è¾“å…¥'); return } $('#codeOut').textContent = src; toast('å·²å¼€å§‹ï¼ˆç¤ºä¾‹ï¼šç›´æ¥å›æ˜¾ï¼‰'); }
    function getResult(){ if(!$('#codeOut').textContent){ toast('æš‚æ— è¾“å‡º'); return } toast('å·²è·å–ç»“æœ'); } toast('å·²è·å–ç»“æœ'); }

    // --- Simple beautifier (è½»é‡å ä½) ---
    async function beautify(){
      let s = $('#codeIn').value || $('#codeOut').textContent || '';
      if(!s){ toast('æ— å¾…ç¾åŒ–å†…å®¹'); return }
      try{
        await ensurePrettier();
        const formatted = prettier.format(s, { parser: 'babel', plugins: [prettierPlugins.babel] });
        $('#codeOut').textContent = formatted;
        toast('å·²ä½¿ç”¨ Prettier ç¾åŒ–');
      }catch(e){
        toast('Prettier å¤±è´¥ï¼š'+e.message);
      }
    } s = s.replace(/;(?=\S)/g,';\n').replace(/\{(?=\S)/g,'{\n').replace(/\}(?=\S)/g,'}\n').replace(/\n{3,}/g,'\n\n'); $('#codeOut').textContent = s; toast('å·²å°è¯•ç¾åŒ–'); }
    function clearAll(){ $('#codeIn').value=''; $('#codeOut').textContent=''; toast('å·²æ¸…é™¤'); }

    // --- Output preview ---
    async function loadOutput(){ const url = `https://raw.githubusercontent.com/${st.repo}/${st.branch}/output.js`; try{ const res = await fetch(url); if(!res.ok) throw new Error(res.status + ' ' + res.statusText); const txt = await res.text(); $('#outputView').textContent = txt.slice(0, 200000); toast('å·²æ‹‰å–æœ€æ–° output.js'); }catch(e){ $('#outputView').textContent = '# æ‹‰å–å¤±è´¥ï¼š' + e.message + '\n' + url; } }
    function downloadOutput(){
      const txt = $('#outputView').textContent;
      const blob = new Blob([txt || ''], {type:'text/javascript;charset=utf-8'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'output.js';
      a.click();
      URL.revokeObjectURL(a.href);
      toast('å·²ä¸‹è½½ output.js');
    }

    // --- Copy helper w/ button feedback ---
    async function copyFrom(sel, btn){ try{ const el = typeof sel === 'string' ? document.querySelector(sel) : sel; const txt = el ? (el.value ?? el.textContent ?? '') : ''; await navigator.clipboard.writeText(txt); if(btn){ const old = btn.textContent; btn.disabled = true; btn.textContent = 'âœ… å·²å¤åˆ¶'; setTimeout(()=>{ btn.textContent = old; btn.disabled = false; }, 1500);} toast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'); }catch(e){ toast('å¤åˆ¶å¤±è´¥ï¼š'+e.message) } }

    // --- Prettier loader ---
    function loadScript(src){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.onload=res; s.onerror=()=>rej(new Error('load failed: '+src)); document.head.appendChild(s); }); }
    async function ensurePrettier(){ if(window.prettier && window.prettierPlugins && window.prettierPlugins.babel) return; await loadScript('https://unpkg.com/prettier@3.2.5/standalone.js'); await loadScript('https://unpkg.com/prettier@3.2.5/plugins/babel.js'); }

    // --- tiny toast ---
    function toast(msg){ const el = document.createElement('div'); el.textContent = msg; el.style.cssText = `position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:10px 14px;border-radius:12px;background:rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.2);backdrop-filter:blur(6px);box-shadow:${getComputedStyle(document.documentElement).getPropertyValue('--shadow')};z-index:9999;font-size:13px`; document.body.appendChild(el); setTimeout(()=>{ el.remove() }, 1600); }

    // --- boot ---
    (function boot(){ applyTheme(); watchSystemTheme(); attachDnd(); $('#repo').value = st.repo; $('#branch').value = st.branch; initLinks(); genRaw(); })();
  </script>
</body>
</html>
