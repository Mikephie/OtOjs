<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Deobf Outputs Viewer</title>
  <style>
    :root { --accent: #6c9cff; --bg:#0b0f14; --panel:#111824; --text:#e8eef7; --muted:#9bb0c9; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px}
    .card{background:var(--panel);border:1px solid #1d2636;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.35)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .head{padding:18px 20px;border-bottom:1px solid #1a2231}
    .body{padding:18px 20px}
    select,button,.path{height:40px;border-radius:10px;border:1px solid #2a3850;background:#0e1521;color:var(--text);padding:0 12px}
    select:focus,button:focus,.path:focus{outline:2px solid var(--accent)}
    button{background:var(--accent);border-color:transparent;font-weight:600;cursor:pointer}
    button.secondary{background:#1b2a42}
    .muted{color:var(--muted)}
    .log{white-space:pre-wrap;background:#0a111c;border:1px solid #1a2231;border-radius:10px;padding:14px;max-height:60vh;overflow:auto;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .tools{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .hidden{display:none}

    /* 圆环进度条 */
    .ring{position:relative;width:86px;height:86px}
    .ring svg{transform:rotate(-90deg);width:86px;height:86px}
    .ring circle.track{stroke:#1f2a3f;stroke-width:8;fill:none}
    .ring circle.progress{stroke:var(--accent);stroke-width:8;fill:none;stroke-linecap:round;stroke-dasharray:251.2; /* 2πr r=40 */ stroke-dashoffset:251.2; transition:stroke-dashoffset .2s linear}
    .ring .txt{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:700}
    .status{display:flex;align-items:center;gap:14px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <div class="row" style="align-items:center;justify-content:space-between">
          <h2 style="margin:0">🧩 Deobf Outputs</h2>
          <span class="muted">选择输出文件 → 获取（带 60 秒动画）</span>
        </div>
      </div>
      <div class="body">
        <div class="row">
          <select id="path">
            <option value="output/output.js">output/output.js</option>
            <option value="output/output.deob2.js">output/output.deob2.js</option>
          </select>
          <input id="custom" class="path" placeholder="或自定义相对路径（可选）"/>
          <button id="fetchBtn">获取文件</button>
          <button class="secondary" id="cancelBtn">取消</button>
        </div>

        <div id="progressBlock" class="row hidden" style="margin-top:14px;align-items:center">
          <div class="status">
            <div class="ring">
              <svg viewBox="0 0 100 100" aria-hidden="true">
                <circle class="track" cx="50" cy="50" r="40"></circle>
                <circle class="progress" id="ringProgress" cx="50" cy="50" r="40"></circle>
              </svg>
              <div class="txt"><span id="count">60</span>s</div>
            </div>
            <div>
              <div id="stateText">正在获取…（最多 60 秒）</div>
              <div class="muted" id="smallHint">若提前获取到内容，会立即结束动画并显示结果</div>
            </div>
          </div>
        </div>

        <div class="tools">
          <button class="secondary" id="copyBtn" title="复制到剪贴板">复制</button>
          <button class="secondary" id="downloadBtn" title="下载文件">下载</button>
        </div>

        <div id="log" class="log" style="margin-top:10px;">📄 等待获取…</div>
      </div>
    </div>
  </div>

  <script>
  (() => {
    const $ = sel => document.querySelector(sel);
    const pathSel = $('#path');
    const custom = $('#custom');
    const fetchBtn = $('#fetchBtn');
    const cancelBtn = $('#cancelBtn');
    const log = $('#log');
    const ring = $('#ringProgress');
    const count = $('#count');
    const progressBlock = $('#progressBlock');
    const stateText = $('#stateText');
    const copyBtn = $('#copyBtn');
    const downloadBtn = $('#downloadBtn');

    let ctrl = null;           // AbortController
    let timer = null;          // 倒计时 setInterval
    let left = 60;             // 秒
    const full = 2 * Math.PI * 40; // 周长 2πr

    function currentPath() {
      const c = custom.value.trim();
      return c ? c : pathSel.value;
    }

    function setProgress(secLeft) {
      count.textContent = secLeft;
      const ratio = (60 - secLeft) / 60; // 0..1
      ring.style.strokeDashoffset = String(full * (1 - ratio));
    }

    function startAnim() {
      left = 60;
      setProgress(left);
      progressBlock.classList.remove('hidden');
      stateText.textContent = '正在获取…（最多 60 秒）';
      timer = setInterval(() => {
        left = Math.max(0, left - 1);
        setProgress(left);
        if (left === 0) {
          stateText.textContent = '仍在获取中…如无响应可取消重试';
          // 不强制中断 fetch；仅提示
          clearInterval(timer);
          timer = null;
        }
      }, 1000);
    }

    function stopAnim() {
      if (timer) { clearInterval(timer); timer = null; }
      progressBlock.classList.add('hidden');
    }

    async function doFetch() {
      const p = currentPath();
      if (ctrl) { ctrl.abort(); }
      ctrl = new AbortController();

      startAnim();
      log.textContent = `📡 GET ${p}\n`;
      try {
        const res = await fetch(p, { signal: ctrl.signal, cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        stopAnim();
        stateText.textContent = '已完成';
        log.textContent = text || '（空文件）';
        // 进度直接填满
        ring.style.strokeDashoffset = '0';
        count.textContent = '0';
      } catch (err) {
        stopAnim();
        log.textContent = `❌ 获取失败：${err.message}\n路径：${p}\n提示：请确认该文件已被工作流产出并提交到仓库；或试试另一个选项/自定义路径。`;
      }
    }

    fetchBtn.addEventListener('click', doFetch);
    cancelBtn.addEventListener('click', () => {
      if (ctrl) ctrl.abort();
      stopAnim();
      log.textContent = '⏹️ 已取消';
    });

    copyBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(log.textContent);
        copyBtn.textContent = '已复制 ✓';
        setTimeout(()=>copyBtn.textContent='复制', 1200);
      } catch { copyBtn.textContent = '复制失败'; setTimeout(()=>copyBtn.textContent='复制', 1200); }
    });

    downloadBtn.addEventListener('click', () => {
      const blob = new Blob([log.textContent], { type: 'text/javascript;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      const name = currentPath().split('/').pop() || 'output.js';
      a.download = name;
      a.click();
      URL.revokeObjectURL(a.href);
    });

    // 初始默认不自动拉取；如需自动拉取，可解除下一行注释
    // doFetch();
  })();
  </script>
</body>
</html>