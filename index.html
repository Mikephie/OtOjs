<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OtOjs Â· æœ€ç®€ç¨³å®šç‰ˆï¼ˆå¸¦å€’è®¡æ—¶ä¸è‡ªåŠ¨ç›‘å¬ï¼‰</title>
<style>
  :root{
    --bg:#0b0f14;--panel:#0f1621;--muted:#9db1c7;--fg:#e6eef7;
    --border:#1f2937;--input:#0f1a2b;--bar:#2dd4bf;--barbg:#0b1020;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--fg)}
  a{color:#67e8f9}
  .wrap{max-width:920px;margin:0 auto;padding:18px 14px 100px}
  h1{margin:10px 0 6px;font-size:20px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;margin:10px 0}
  label{font-size:12px;color:var(--muted);margin-right:6px;display:block;margin-bottom:4px}
  input,select,textarea{width:100%;background:var(--input);color:var(--fg);border:1px solid #223046;border-radius:10px;padding:10px;font-size:13px}
  textarea{min-height:160px;font-family:ui-monospace,Consolas,Menlo,monospace}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0}
  .row>*{flex:1 1 200px}
  button{padding:10px 12px;border-radius:10px;border:1px solid #2b3b54;background:#152033;color:var(--fg);cursor:pointer;font-weight:600}
  button.ok{border-color:#10b981}
  button.warn{border-color:#f59e0b}
  button.err{border-color:#ef4444}
  pre{white-space:pre-wrap;background:var(--barbg);border:1px solid #223046;border-radius:10px;padding:10px;font-size:12px;max-height:420px;overflow:auto}
  small{color:var(--muted)}
  .timer{display:flex;align-items:center;gap:14px;margin-top:8px}
  .ring{width:64px;height:64px;border-radius:50%;border:6px solid #0e1a2a;border-top-color:var(--bar);display:flex;align-items:center;justify-content:center;font-weight:700}
  .barWrap{flex:1;height:10px;background:#0e1630;border-radius:999px;overflow:hidden;border:1px solid #223046}
  .bar{height:100%;width:0;background:var(--bar);transition:width .08s linear}
  .status{min-height:20px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:640px){.grid2{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <h1>OtOjs Â· æœ€ç®€ç¨³å®šç‰ˆï¼ˆå¸¦å€’è®¡æ—¶ + è‡ªåŠ¨ç›‘å¬ï¼‰</h1>

  <!-- åŸºæœ¬é…ç½® -->
  <div class="card">
    <div class="row">
      <div style="flex:2">
        <label>REPO</label>
        <input id="repo" value="Mikephie/OtOjs" />
      </div>
      <div>
        <label>BRANCH</label>
        <input id="branch" value="main" />
      </div>
      <div>
        <label>Tokenï¼ˆéœ€è¦ contents: read & writeï¼‰</label>
        <input id="token" type="password" placeholder="ghp_..." />
      </div>
    </div>
    <div class="row">
      <div>
        <label>input.js è·¯å¾„</label>
        <input id="pathIn" value="input.js" />
      </div>
      <div>
        <label>output è·¯å¾„é€‰æ‹©ï¼ˆè‡ªå®šä¹‰ä¼˜å…ˆï¼‰</label>
        <div class="grid2">
          <select id="pathOut">
            <option value="output/output.js">output/output.js</option>
            <option value="output/output.deob2.js">output/output.deob2.js</option>
          </select>
          <div>
            <label style="margin:0 0 6px 0">è‡ªåŠ¨ç›‘å¬ outputï¼ˆæ¯ 5s æ£€æŸ¥ shaï¼‰</label>
            <input id="autoWatch" type="checkbox" checked />
          </div>
        </div>
      </div>
      <div>
        <label>æäº¤ä¿¡æ¯</label>
        <input id="commitMsg" value="update: input.js via UI" />
      </div>
    </div>
  </div>

  <!-- æäº¤ä¸è·å– -->
  <div class="card">
    <small>æŠŠå¾…è§£å¯†è„šæœ¬æ”¾åˆ° <b>input.js</b> â†’ ç­‰çº¦ 60 ç§’ â†’ åœ¨é€‰å®šçš„ <b>output/â€¦</b> æŸ¥çœ‹ï¼ˆæå‰è·å–ä¼šç«‹åˆ»ç»“æŸåŠ¨ç”»ï¼‰</small>

    <div class="row">
      <input type="file" id="file" accept=".js,.txt,.json" />
      <button onclick="pick()">é€‰æ‹©æ–‡ä»¶</button>
      <input id="remoteUrl" placeholder="https:// åŸå§‹è„šæœ¬ URLï¼ˆæ”¯æŒ github/blob è‡ªåŠ¨è½¬ rawï¼‰" />
      <button onclick="loadRemote()">è¿œç¨‹åŠ è½½</button>
      <button onclick="pasteFromClipboard()">ç²˜è´´æ¿</button>
      <button class="err" onclick="clrIn()">æ¸…ç©ºè¾“å…¥</button>
    </div>

    <textarea id="codeIn" placeholder="æŠŠå¾…è§£å¯†çš„ JS ç²˜è´´åˆ°è¿™é‡Œï¼Œæˆ–ç”¨ä¸Šæ–¹å¯¼å…¥"></textarea>

    <div class="row">
      <button class="ok"   onclick="submitInput()">â‘  æäº¤åˆ° input.js (PUT)</button>
      <button class="warn" onclick="pollOutput(60)">â‘¡ ç­‰å¾…å¹¶è½®è¯¢é€‰å®šçš„ output (60s)</button>
      <button onclick="beautify()">ï¼ˆå¯é€‰ï¼‰ç»“æœç¾åŒ–</button>
      <button onclick="copySel('#codeOut', this)">å¤åˆ¶ç»“æœ</button>
      <button class="err" onclick="clrAll()">æ¸…ç©ºè¾“å…¥ä¸ç»“æœ</button>
    </div>

    <!-- å€’è®¡æ—¶ + è¿›åº¦æ¡ï¼ˆåŒå¸§åŒæ­¥ï¼‰ -->
    <div class="timer">
      <div class="ring"><span id="secs">0s</span></div>
      <div class="barWrap"><div id="bar" class="bar"></div></div>
      <button id="cancelBtn" onclick="cancelPolling()" style="min-width:90px">å–æ¶ˆ</button>
    </div>

    <div id="status" class="status"><small>çŠ¶æ€ï¼šå°±ç»ª</small></div>
    <pre id="codeOut" placeholder="ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ"></pre>
  </div>

  <!-- Raw æ‹‰å– / å¤åˆ¶ / ä¸‹è½½ -->
  <div class="card">
    <div class="row">
      <button onclick="loadOutputRaw()">æ‹‰å–æœ€æ–° output (Raw)</button>
      <button onclick="copySel('#outputRaw', this)">å¤åˆ¶</button>
      <button onclick="downloadOutput()">ä¸‹è½½ output.js</button>
    </div>
    <pre id="outputRaw"></pre>
  </div>
</div>

<script>
/* ============ å·¥å…· ============ */
const $=s=>document.querySelector(s);
function setStatus(msg){ $('#status').innerHTML = '<small>çŠ¶æ€ï¼š'+ msg +'</small>'; }
function ghHeaders(){
  const t=$('#token').value.trim();
  if(!t) throw new Error('ç¼ºå°‘ Tokenï¼ˆéœ€è¦ contents: read & writeï¼‰');
  return { 'Authorization':'Bearer '+t, 'Accept':'application/vnd.github+json' };
}
function repoBase(){ return `https://api.github.com/repos/${$('#repo').value.trim()}` }
function rawUrl(path){ return `https://raw.githubusercontent.com/${$('#repo').value.trim()}/${$('#branch').value.trim()}/${path}` }

function pick(){ $('#file').click(); }
$('#file').addEventListener('change', async (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  const txt=await f.text(); $('#codeIn').value=txt; setStatus('å·²è½½å…¥æœ¬åœ°æ–‡ä»¶ï¼š'+f.name+' Â· '+txt.length+' å­—ç¬¦');
});

async function loadRemote(){
  let u=$('#remoteUrl').value.trim(); if(!u){ setStatus('è¯·è¾“å…¥ URL'); return }
  if(/https?:\/\/github\.com\/.+\/blob\//.test(u)){
    u=u.replace('https://github.com/','https://raw.githubusercontent.com/').replace('/blob/','/');
  }
  try{
    const r=await fetch(u,{cache:'no-cache'}); const t=await r.text();
    if(!r.ok) throw new Error(r.status+' '+r.statusText+' '+t.slice(0,200));
    $('#codeIn').value=t; setStatus('è¿œç¨‹å·²åŠ è½½ Â· '+t.length+' å­—ç¬¦');
  }catch(e){ setStatus('è¿œç¨‹åŠ è½½å¤±è´¥ï¼š'+e.message); }
}
async function pasteFromClipboard(){
  try{ const t=await navigator.clipboard.readText(); $('#codeIn').value=t; setStatus('å·²ä»å‰ªè´´æ¿ç²˜è´´ Â· '+t.length+' å­—ç¬¦'); }
  catch(e){ setStatus('ç²˜è´´å¤±è´¥ï¼š'+e.message); }
}
function clrIn(){ $('#codeIn').value=''; setStatus('å·²æ¸…ç©ºè¾“å…¥'); }
function clrAll(){ $('#codeIn').value=''; $('#codeOut').textContent=''; setStatus('å·²æ¸…ç©ºè¾“å…¥ä¸ç»“æœ'); }

/* ============ åŒå¸§åŒæ­¥è®¡æ—¶ ============ */
let rafId=0, pollingAbort=false;
function startTimer(totalSec){
  const start = performance.now();
  cancelAnimationFrame(rafId);

  const frame = ()=>{
    const t = (performance.now() - start) / 1000;          // å·²è¿‡ç§’
    const left = Math.max(0, totalSec - t);                 // å‰©ä½™ç§’ï¼ˆæµ®ç‚¹ï¼‰
    const leftInt = Math.ceil(left);                        // å€’æ•°æ˜¾ç¤ºï¼ˆå‘ä¸Šå–æ•´ï¼‰
    const pct = Math.min(100, Math.max(0, (t/totalSec)*100));

    $('#secs').textContent = leftInt + 's';
    $('#bar').style.width = pct + '%';

    if (!pollingAbort && left > 0) rafId = requestAnimationFrame(frame);
  };
  pollingAbort=false;
  frame();
}
function stopTimer(){
  cancelAnimationFrame(rafId);
  $('#bar').style.width = '100%';
}
function cancelPolling(){
  pollingAbort=true;
  stopTimer();
  setStatus('å·²å–æ¶ˆè½®è¯¢');
}

/* ============ è‡ªåŠ¨ç›‘å¬ï¼šsha å˜æ›´å³æ‹‰å– ============ */
let watchTimer = null;
let lastSha = '';      // æœ€è¿‘ä¸€æ¬¡çœ‹åˆ°çš„ sha
async function fetchOutputOnce(showStatus=true){
  const path = $('#pathOut').value.trim() || 'output/output.js';
  const api  = `${repoBase()}/contents/${path}?ref=${$('#branch').value.trim()}`;
  try{
    const r = await fetch(api, { headers: ghHeaders(), cache:'no-cache' });
    const raw = await r.text();
    if(!r.ok) { if(showStatus) setStatus(`ç›‘å¬ï¼š${r.status} ${r.statusText}`); return false; }
    const j = JSON.parse(raw);
    const sha = j.sha || '';
    if(sha && sha !== lastSha){
      lastSha = sha;
      const b64 = (j.content||'').replace(/\n/g,'');
      const out = j.content ? decodeURIComponent(escape(atob(b64))) : '';
      if(out.trim()){
        $('#codeOut').textContent = out;
        setStatus('ğŸ”” ç›‘å¬åˆ°æ–°äº§ç‰©å¹¶å·²æ˜¾ç¤ºï¼š' + path);
        return true;
      }
    }
  }catch(e){
    if(showStatus) setStatus('ç›‘å¬å¼‚å¸¸ï¼š' + e.message);
  }
  return false;
}
function startWatch(intervalMs=5000){
  if(!$('#autoWatch').checked) return;
  clearInterval(watchTimer);
  // å…ˆæŠ“ä¸€æ¬¡ï¼ˆå¯èƒ½åˆšå¥½å·²ç»äº§å‡ºï¼‰
  fetchOutputOnce(false);
  watchTimer = setInterval(()=>fetchOutputOnce(false), intervalMs);
  setStatus('å·²å¼€å¯è‡ªåŠ¨ç›‘å¬ï¼ˆæ¯ 5s æ£€æŸ¥ï¼‰');
}
function stopWatch(){
  clearInterval(watchTimer);
  watchTimer = null;
  setStatus('å·²åœæ­¢è‡ªåŠ¨ç›‘å¬');
}
$('#autoWatch').addEventListener('change', e=>{
  if(e.target.checked) startWatch(); else stopWatch();
});
$('#pathOut').addEventListener('change', ()=>{ lastSha=''; if($('#autoWatch').checked){ startWatch(); }});

/* ============ æäº¤ input.js ============ */
async function submitInput(){
  const path=$('#pathIn').value.trim()||'input.js';
  const api=`${repoBase()}/contents/${path}`;
  const code=$('#codeIn').value; if(!code){ setStatus('æ²¡æœ‰å¯ä¸Šä¼ çš„å†…å®¹'); return }
  try{
    ghHeaders(); // æ ¡éªŒ token
    let sha='';
    const head=await fetch(`${api}?ref=${$('#branch').value.trim()}`,{headers:ghHeaders()});
    if(head.ok){ const j=await head.json(); sha=j.sha||''; }
    const body={ message: $('#commitMsg').value.trim()||'update via UI', content: btoa(unescape(encodeURIComponent(code))), branch: $('#branch').value.trim(), sha: sha||undefined };
    const res=await fetch(api,{ method:'PUT', headers:{ 'Content-Type':'application/json', ...ghHeaders() }, body: JSON.stringify(body) });
    const txt=await res.text();
    if(!res.ok) throw new Error(res.status+' '+res.statusText+' â†’ '+txt.slice(0,200));
    setStatus('æäº¤æˆåŠŸ Â· å·²å†™å…¥ '+path+'ï¼Œè‡ªåŠ¨å¼€å§‹è½®è¯¢ 60s');
    pollOutput(60);     // ç«‹å³è½®è¯¢ä¸€æ¬¡ï¼ˆå¸¦å€’è®¡æ—¶åŠ¨ç”»ï¼‰
    startWatch();       // åç»­ç»§ç»­åå°ç›‘å¬ï¼Œsha å˜å°±è‡ªåŠ¨æ˜¾ç¤º
  }catch(e){ setStatus('æäº¤å¤±è´¥ï¼š'+e.message); }
}

/* ============ è½®è¯¢ 60sï¼šåŒå¸§è®¡æ—¶ + æå‰ç»“æŸ ============ */
async function pollOutput(seconds){
  try{ ghHeaders(); }catch(e){ setStatus(e.message); return }
  const path=$('#pathOut').value.trim()||'output/output.js';
  const api =`${repoBase()}/contents/${path}?ref=${$('#branch').value.trim()}`;
  const t0 = Date.now();
  let last='';

  startTimer(seconds);
  setStatus('å¼€å§‹è½®è¯¢ '+seconds+'sâ€¦ å¦‚æå‰æ‹¿åˆ°ä¼šç«‹åˆ»ç»“æŸå¹¶æ˜¾ç¤ºç»“æœ');

  while(!pollingAbort && (Date.now()-t0)/1000 < seconds){
    try{
      const r=await fetch(api,{headers:ghHeaders(),cache:'no-cache'}); 
      const raw=await r.text();
      if(r.ok){
        const j=JSON.parse(raw);
        const b64=(j.content||'').replace(/\n/g,'');
        const out=j.content?decodeURIComponent(escape(atob(b64))):'';
        if(out && out.trim()){
          $('#codeOut').textContent=out;
          lastSha = j.sha || lastSha;
          stopTimer();
          setStatus('âœ… å·²è·å–åˆ°ï¼š'+path);
          return;
        }
      }else{
        last=r.status+' '+r.statusText;
      }
    }catch(e){ last=e.message }

    // é—´éš” 5s
    await new Promise(r=>setTimeout(r,5000));
    const spent=Math.floor((Date.now()-t0)/1000);
    setStatus('ç­‰å¾…ä¸­â€¦ '+spent+'/'+seconds+'s'+(last?(' Â· ä¸Šæ¬¡ï¼š'+last):''));
  }
  stopTimer();
  setStatus('âŒ› ä»æœªè·å–åˆ° '+path+'ï¼Œå°†ç»§ç»­åœ¨åå°ç›‘å¬ï¼ˆé€‰ä¸­è‡ªåŠ¨ç›‘å¬åˆ™ä¼šè‡ªåŠ¨æ˜¾ç¤ºï¼‰');
}

/* ============ Raw / ä¸‹è½½ / ç¾åŒ– / å¤åˆ¶ ============ */
async function loadOutputRaw(){
  const path=$('#pathOut').value.trim()||'output/output.js';
  const url=rawUrl(path);
  try{ const r=await fetch(url,{cache:'no-cache'}); const t=await r.text(); if(!r.ok) throw new Error(r.status+' '+r.statusText); $('#outputRaw').textContent=t; setStatus('å·²æ‹‰å– Raw Â· '+t.length+' å­—ç¬¦'); }
  catch(e){ $('#outputRaw').textContent='æ‹‰å–å¤±è´¥ï¼š'+e.message+'\n'+url; setStatus('æ‹‰å–å¤±è´¥'); }
}
function downloadOutput(){ const t=$('#outputRaw').textContent||$('#codeOut').textContent||''; const b=new Blob([t],{type:'text/javascript;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='output.js'; a.click(); URL.revokeObjectURL(a.href); }

async function ensurePrettier(){
  if(window.prettier && window.prettierPlugins && window.prettierPlugins.babel) return;
  const s1=document.createElement('script'); s1.src='https://unpkg.com/prettier@3.2.5/standalone.js';
  const s2=document.createElement('script'); s2.src='https://unpkg.com/prettier@3.2.5/plugins/babel.js';
  document.body.appendChild(s1); await new Promise(r=>s1.onload=r);
  document.body.appendChild(s2); await new Promise(r=>s2.onload=r);
}
async function beautify(){
  let s=$('#codeOut').textContent||$('#codeIn').value||'';
  if(!s){ setStatus('æ— å¾…ç¾åŒ–å†…å®¹'); return }
  try{
    await ensurePrettier();
    const out=prettier.format(s,{parser:'babel',plugins:[prettierPlugins.babel]});
    $('#codeOut').textContent=out; setStatus('å·²ç”¨ Prettier ç¾åŒ–');
  }catch(e){ setStatus('Prettier å¤±è´¥ï¼š'+e.message); }
}
async function copySel(sel,btn){
  try{ const el=$(sel); const t=el?(el.value??el.textContent??''):''; await navigator.clipboard.writeText(t); btn.textContent='âœ… å·²å¤åˆ¶'; setTimeout(()=>btn.textContent='å¤åˆ¶ç»“æœ',1200); }
  catch(e){ setStatus('å¤åˆ¶å¤±è´¥ï¼š'+e.message); }
}

/* åˆå§‹ï¼šè‹¥å‹¾é€‰åˆ™å¯åŠ¨ç›‘å¬ */
window.addEventListener('load', ()=>{ if($('#autoWatch').checked) startWatch(); });
</script>
</body>
</html>