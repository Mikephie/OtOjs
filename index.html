<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OtOjs 控制台 + 解码器（稳定修复版）</title>
  <meta name="description" content="GitHub 快捷操作 + 固定解密流程：提交 input.js → 等待 ~60s 轮询 output.js。支持文件/远程/粘贴、Prettier、美化、复制、下载。" />
  <style>
    :root{--bg:radial-gradient(1200px 800px at 10% 0%,#0ea5e95c 0%,transparent 50%),radial-gradient(900px 700px at 90% 20%,#22c55e40 0%,transparent 60%),linear-gradient(180deg,#0b0f14 0%,#0b0f14 60%,#0b0f14 100%);--card:rgba(255,255,255,.06);--card-2:rgba(255,255,255,.08);--text:#e6eef7;--muted:#9db1c7;--accent:#6ee7ff;--ok:#10b981;--warn:#f59e0b;--err:#ef4444;--radius:18px;--shadow:0 10px 30px rgba(0,0,0,.28),inset 0 1px 0 rgba(255,255,255,.06);--glass:blur(8px) saturate(120%)}
    *{box-sizing:border-box}
    body{margin:0;color:var(--text);background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    a{color:var(--accent)}
    .container{max-width:1200px;margin:0 auto;padding:20px 12px 100px}
    header{display:flex;align-items:center;gap:12px;margin:8px 0 16px}
    .logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#22d3ee,#a78bfa);box-shadow:0 8px 24px rgba(124,58,237,.35),inset 0 1px 0 rgba(255,255,255,.3)}
    h1{font-size:22px;margin:0}
    .muted{color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .card{grid-column:span 12;background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:var(--glass)}
    .card h2{margin:0;padding:14px 14px 6px;font-size:15px}
    .sub{color:var(--muted);font-size:12px;padding:0 14px 8px}
    .section{padding:10px 14px 14px}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .field{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input,textarea{background:var(--card-2);border:1px solid rgba(255,255,255,.08);color:var(--text);border-radius:12px;padding:10px 12px;outline:none}
    input[type=text],input[type=url],input[type=password]{flex:1;min-width:180px}
    textarea{width:100%;min-height:140px;font-family:ui-monospace,Consolas,Menlo,monospace;font-size:12px}
    .btn{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:linear-gradient(180deg,rgba(255,255,255,.1),rgba(255,255,255,.05));color:var(--text);cursor:pointer;font-weight:600;font-size:13px;box-shadow:var(--shadow)}
    .btn.ok{border-color:rgba(16,185,129,.35)}.btn.warn{border-color:rgba(245,158,11,.35)}.btn.err{border-color:rgba(239,68,68,.35)}
    .code{white-space:pre-wrap;background:#0b1020;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px;font-size:12px;overflow:auto}
    .drop{border:2px dashed rgba(255,255,255,.25);border-radius:16px;padding:22px;text-align:center;color:var(--muted)}
    .drop.drag{border-color:var(--accent);color:var(--accent)}
    footer{text-align:center;color:var(--muted);font-size:12px;margin-top:16px}
    @media(max-width:720px){.row>*{flex:1 1 100%}input,textarea{font-size:15px;padding:12px}.btn{font-size:15px;padding:12px}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>OtOjs 控制台 + 解码器（稳定修复版）</h1>
        <div class="muted">固定流程：提交 input.js → 等待 ~60s 轮询 output.js · 纯前端</div>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <h2>① 仓库设置 & Raw/API</h2>
        <div class="sub">设置后用于生成 Raw 链接、API 地址。</div>
        <div class="section">
          <div class="field">
            <label>REPO</label><input id="repo" type="text" value="Mikephie/OtOjs" />
            <label>BRANCH</label><input id="branch" type="text" value="main" />
            <button class="btn" id="btnSaveRepo">保存</button>
          </div>
        </div>
        <div class="section">
          <div class="field">
            <input id="relPath" type="text" value="input.js" placeholder="input.js 或 src/xxx.js" />
            <button class="btn" id="btnGenRaw">生成 Raw/API</button>
            <button class="btn" id="btnCopyRaw">复制</button>
          </div>
          <div id="rawOut" class="code" style="margin-top:8px"></div>
        </div>
      </section>

      <section class="card">
        <h2>② GitHub API 命令与直连</h2>
        <div class="sub">需要 Token（contents: read & write）。可生成 curl 或直接调用 API。</div>
        <div class="section">
          <div class="field"><input id="apiPath" type="text" value="input.js" /><input id="apiMsg" type="text" value="update: input.js via OtOjs UI" /></div>
          <div class="row">
            <button class="btn" id="btnCurlPut">生成 curl (PUT)</button>
            <button class="btn warn" id="btnCurlGet">生成 curl (GET)</button>
            <button class="btn" id="btnCurlCopy">复制</button>
          </div>
          <div class="row">
            <input id="apiToken" type="password" placeholder="ghp_xxx Personal Access Token" />
            <button class="btn ok" id="btnApiPut">直接上传 (PUT)</button>
            <button class="btn" id="btnApiGet">读取 (GET)</button>
          </div>
          <div id="curlOut" class="code" style="margin-top:8px"></div>
        </div>
      </section>

      <section class="card">
        <h2>🧪 解密流程（提交 input.js → 等待轮询）</h2>
        <div class="sub">把待解密脚本放入 <code>input.js</code>，等待 ~60s 自动产出 <code>output.js</code>。</div>
        <div class="section">
          <div id="drop" class="drop">点击选择文件或拖入（.js .txt .json）</div>
          <div class="row" style="margin-top:8px">
            <input type="file" id="file" accept=".js,.txt,.json" />
            <button class="btn" id="btnPick">选择文件</button>
            <input id="remoteUrl" type="url" placeholder="https:// 远程脚本地址（支持 github/blob 自动转 raw）" />
            <button class="btn" id="btnRemote">远程加载</button>
            <button class="btn" id="btnPaste">粘贴板</button>
            <button class="btn err" id="btnClearInput">清空输入</button>
          </div>
        </div>
        <div class="section">
          <textarea id="codeIn" placeholder="把待解密的 JavaScript 贴在这里，或用上面的文件/远程/粘贴导入"></textarea>
        </div>
        <div class="section">
          <div class="row">
            <button class="btn ok" id="btnSubmitInput">① 提交到 input.js (PUT)</button>
            <button class="btn warn" id="btnWaitPoll">② 开始等待并轮询 (60s)</button>
            <button class="btn" id="btnBeautify">（可选）结果代码美化</button>
            <button class="btn" id="btnCopyOut">复制结果</button>
            <button class="btn err" id="btnClearAll">清空输入与结果</button>
          </div>
          <div id="status" class="sub" style="margin-top:6px"></div>
          <pre id="codeOut" class="code" style="margin-top:8px;min-height:160px"></pre>
        </div>
      </section>

      <section class="card">
        <h2>③ output.js 预览</h2>
        <div class="sub">从 Raw 拉取快速查看，并可下载</div>
        <div class="section">
          <div class="row">
            <button class="btn" id="btnLoadOutput">拉取最新输出</button>
            <button class="btn" id="btnCopyOutput">复制</button>
            <button class="btn" id="btnDownloadOutput">下载 output.js</button>
          </div>
          <pre id="outputView" class="code" style="margin-top:8px;max-height:360px"></pre>
        </div>
      </section>
    </div>

    <footer>OtOjs · 可直接放 docs/ 作为 GitHub Pages</footer>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const st = { get repo(){return localStorage.getItem('repo')||'Mikephie/OtOjs'}, set repo(v){localStorage.setItem('repo',v)}, get branch(){return localStorage.getItem('branch')||'main'}, set branch(v){localStorage.setItem('branch',v)} };

    function toast(msg){ const el=document.createElement('div'); el.textContent=msg; el.style.cssText='position:fixed;left:50%;bottom:18px;transform:translateX(-50%);padding:10px 12px;border-radius:12px;background:rgba(0,0,0,.65);border:1px solid rgba(255,255,255,.2);color:#fff;font-size:12px;z-index:9999'; document.body.appendChild(el); setTimeout(()=>el.remove(),1800); }

    function genRaw(){ const rel=$('#relPath').value.trim().replace(/^\/+/, '')||'input.js'; const raw=`https://raw.githubusercontent.com/${st.repo}/${st.branch}/${rel}`; const api=`https://api.github.com/repos/${st.repo}/contents/${rel}?ref=${encodeURIComponent(st.branch)}`; $('#rawOut').textContent=`# 公共直链 (Raw)\n${raw}\n\n# 私库 / 需 token 的 API 读取\n${api}`; $('#status').textContent=''; }

    function mustHeaders(){ const t=$('#apiToken').value.trim(); if(!t){ throw new Error('缺少 Token：请在“② GitHub API 命令与直连”中填写 ghp_...'); } return { 'Authorization': `Bearer ${t}`, 'Accept': 'application/vnd.github+json' }; }

    async function genCurl(kind){ const path=$('#apiPath').value.trim().replace(/^\/+/, ''); const msg=$('#apiMsg').value.trim(); const api=`https://api.github.com/repos/${st.repo}/contents/${path}`; if(kind==='GET'){ $('#curlOut').textContent=`curl -H "Authorization: Bearer YOUR_TOKEN" \n  -H "Accept: application/vnd.github+json" \n  \"${api}?ref=${st.branch}\"`; return; } try{ let sha=''; const r=await fetch(`${api}?ref=${st.branch}`); if(r.ok){ const j=await r.json(); sha=j.sha||''; } const src=$('#codeIn').value||$('#codeOut').textContent||'/* replace with your JS */'; const body={message:msg,content:btoa(unescape(encodeURIComponent(src))),branch:st.branch,sha:sha||undefined}; $('#curlOut').textContent=[`curl -X PUT \\\`,`  -H "Authorization: Bearer YOUR_TOKEN" \\\`,`  -H "Accept: application/vnd.github+json" \\\`,`  ${JSON.stringify(api)} \\\`,`  -d ${JSON.stringify(JSON.stringify(body))}`].join('\n'); }catch(e){ $('#curlOut').textContent='# 生成失败：'+e.message; } }

    async function apiGet(){ const path=$('#apiPath').value.trim().replace(/^\/+/, ''); const api=`https://api.github.com/repos/${st.repo}/contents/${path}?ref=${st.branch}`; try{ const res=await fetch(api,{headers:mustHeaders()}); const rawText=await res.text(); if(!res.ok){ $('#status').textContent=`GET ${res.status} ${res.statusText} → ${rawText.slice(0,300)}`; throw new Error(res.status+' '+res.statusText); } const j=JSON.parse(rawText); const b64=(j.content||'').replace(/\n/g,''); const s=j.content?decodeURIComponent(escape(atob(b64))):''; $('#codeOut').textContent=s; $('#status').textContent=`GET 成功 · sha=${j.sha} · size=${j.size}`; toast('已读取 '+path); }catch(e){ toast('读取失败：'+e.message); } }

    async function apiPut(){ const path=$('#apiPath').value.trim().replace(/^\/+/, ''); const msg=$('#apiMsg').value.trim()||'update via UI'; const api=`https://api.github.com/repos/${st.repo}/contents/${path}`; const src=$('#codeIn').value.trim()||$('#codeOut').textContent||''; if(!src){ toast('没有可上传的内容'); return } try{ let sha=''; const chk=await fetch(`${api}?ref=${st.branch}`,{headers:mustHeaders()}); const chkTxt=await chk.text(); if(chk.ok){ const j=JSON.parse(chkTxt); sha=j.sha||''; } else if(chk.status!==404){ $('#status').textContent=`HEAD 查 sha 失败：${chk.status} ${chk.statusText} → ${chkTxt.slice(0,300)}`; } const body={message:msg,content:btoa(unescape(encodeURIComponent(src))),branch:st.branch,sha:sha||undefined}; const res=await fetch(api,{method:'PUT',headers:{'Content-Type':'application/json',...mustHeaders()},body:JSON.stringify(body)}); const resTxt=await res.text(); if(!res.ok){ $('#status').textContent=`PUT 失败：${res.status} ${res.statusText} → ${resTxt.slice(0,500)}`; throw new Error(res.status+' '+res.statusText); } const jr=JSON.parse(resTxt); $('#status').textContent=`PUT 成功 · commit=${jr.commit?.sha?.slice(0,7)||'N/A'} · new sha=${jr.content?.sha||'N/A'}`; toast('上传成功'); }catch(e){ toast('上传失败：'+e.message); } }

    // ——— 解码器 I/O ———
    function setCodeIn(text){ const ta=$('#codeIn'); const s=String(text??''); ta.value=s; ta.textContent=s; ta.innerHTML=''; ta.style.visibility='hidden'; ta.offsetHeight; ta.style.visibility='visible'; requestAnimationFrame(()=>{ ta.value=s; }); const stEl=$('#status'); if(stEl) stEl.textContent=`已载入内容 · 长度 ${s.length} 字符`; }
    function pickFile(){ $('#file').click(); }
    function readFile(f){ return new Promise((resolve,reject)=>{ const r=new FileReader(); r.onload=()=>resolve(r.result); r.onerror=reject; r.readAsText(f,'utf-8'); }); }
    function attachDnd(){ const box=$('#drop'); box.addEventListener('dragover',e=>{e.preventDefault(); box.classList.add('drag')}); box.addEventListener('dragleave',()=>box.classList.remove('drag')); box.addEventListener('drop',async e=>{e.preventDefault(); box.classList.remove('drag'); const f=e.dataTransfer.files?.[0]; if(f){ const txt=await readFile(f); setCodeIn(txt); toast('已载入：'+f.name); }}); }
    async function loadRemote(){ let u=$('#remoteUrl').value.trim(); if(!u){ toast('请输入 URL'); return } if(/https?:\/\/github\.com\/.+\/blob\//.test(u)){ u=u.replace(/https?:\/\/github\.com\//,'https://raw.githubusercontent.com/').replace(/\/blob\//,'/'); } const tryUrls=[u]; const m=u.match(/^https?:\/\/raw\.githubusercontent\.com\/([^/]+)\/([^/]+)\/([^/]+)\/(.+)$/); if(m){ const [,user,repo,branch,path]=m; tryUrls.push(`https://cdn.jsdelivr.net/gh/${user}/${repo}@${branch}/${path}`); } let lastErr=''; for(const url of tryUrls){ try{ const res=await fetch(url,{cache:'no-cache'}); const txt=await res.text(); if(!res.ok){ lastErr=`${res.status} ${res.statusText}`; continue } setCodeIn(txt); toast('已加载远程脚本'); return }catch(e){ lastErr=e.message } } toast('加载失败：'+lastErr); }
    async function pasteClipboard(){ try{ const t=await navigator.clipboard.readText(); setCodeIn(t); toast('已粘贴'); }catch(e){ toast('读取剪贴板失败：'+e.message); } }
    function clearInput(){ setCodeIn(''); toast('已清空输入'); }

    // 固定流程：提交 input.js + 轮询 output.js
    async function submitToInputJs(){ $('#apiPath').value='input.js'; $('#apiMsg').value='update: input.js via OtOjs UI'; await apiPut(); $('#status').textContent='已提交到 input.js，下一步：点击“② 开始等待并轮询 (60s)”'; }
    async function waitAndPollOutput(seconds=60){ try{ mustHeaders() }catch(e){ toast(e.message); return } $('#status').textContent=`已开始等待，预计 ${seconds}s；期间每5s轮询 output.js ...`; const api=`https://api.github.com/repos/${st.repo}/contents/output.js?ref=${st.branch}`; const t0=Date.now(); let found=false; let lastErr=''; while((Date.now()-t0)/1000<seconds){ try{ const res=await fetch(api,{headers:mustHeaders()}); const txt=await res.text(); if(res.ok){ const j=JSON.parse(txt); const b64=(j.content||'').replace(/\n/g,''); const out=j.content?decodeURIComponent(escape(atob(b64))):''; if(out && out.trim().length){ $('#codeOut').textContent=out; found=true; break } }else{ lastErr=`${res.status} ${res.statusText}` } }catch(e){ lastErr=e.message } await new Promise(r=>setTimeout(r,5000)); $('#status').textContent=`等待中… 已过 ${Math.floor((Date.now()-t0)/1000)}s / ${seconds}s`+(lastErr?` · 上次响应：${lastErr}`:''); } if(found){ $('#status').textContent='✅ 已在 output.js 获取到结果（已填入下方结果区）'; toast('已获取 output.js'); } else { $('#status').textContent='⌛ 未在设定时长内获取到 output.js，可再等一会儿或下方“拉取最新输出”。'; toast('暂未获取到结果'); } }

    // Prettier
    function loadScript(src){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.onload=res; s.onerror=()=>rej(new Error('load failed: '+src)); document.head.appendChild(s); }); }
    async function ensurePrettier(){ if(window.prettier && window.prettierPlugins && window.prettierPlugins.babel) return; await loadScript('https://unpkg.com/prettier@3.2.5/standalone.js'); await loadScript('https://unpkg.com/prettier@3.2.5/plugins/babel.js'); }
    async function beautify(){ let s=$('#codeOut').textContent||$('#codeIn').value||''; if(!s){ toast('无待美化内容'); return } try{ await ensurePrettier(); const out=prettier.format(s,{parser:'babel',plugins:[prettierPlugins.babel]}); $('#codeOut').textContent=out; toast('已使用 Prettier 美化'); }catch(e){ toast('Prettier 失败：'+e.message); } }

    async function loadOutput(){ const url=`https://raw.githubusercontent.com/${st.repo}/${st.branch}/output.js`; try{ const r=await fetch(url); if(!r.ok) throw new Error(r.status+' '+r.statusText); $('#outputView').textContent=(await r.text()).slice(0,200000); toast('已拉取 output.js'); }catch(e){ $('#outputView').textContent='# 拉取失败：'+e.message+'\n'+url; } }
    function downloadOutput(){ const txt=$('#outputView').textContent||''; const blob=new Blob([txt],{type:'text/javascript;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='output.js'; a.click(); URL.revokeObjectURL(a.href); toast('已下载 output.js'); }

    async function copy(sel, btnSel){ try{ const el=$(sel); const txt=el ? (el.value ?? el.textContent ?? '') : ''; await navigator.clipboard.writeText(txt); const b=$(btnSel); if(b){ const o=b.textContent; b.textContent='✅ 已复制'; b.disabled=true; setTimeout(()=>{b.textContent=o; b.disabled=false},1200); } toast('已复制'); }catch(e){ toast('复制失败：'+e.message); } }

    function bind(){ $('#repo').value=st.repo; $('#branch').value=st.branch; genRaw(); attachDnd(); $('#btnSaveRepo').addEventListener('click',()=>{ st.repo=$('#repo').value.trim(); st.branch=$('#branch').value.trim(); genRaw(); toast('已保存'); }); $('#btnGenRaw').addEventListener('click',genRaw); $('#btnCopyRaw').addEventListener('click',()=>copy('#rawOut','#btnCopyRaw')); $('#btnCurlPut').addEventListener('click',()=>genCurl('PUT')); $('#btnCurlGet').addEventListener('click',()=>genCurl('GET')); $('#btnCurlCopy').addEventListener('click',()=>copy('#curlOut','#btnCurlCopy')); $('#btnApiPut').addEventListener('click',apiPut); $('#btnApiGet').addEventListener('click',apiGet); $('#btnPick').addEventListener('click',()=>$('#file').click()); $('#file').addEventListener('change',async e=>{ const f=e.target.files?.[0]; if(f){ const txt=await readFile(f); setCodeIn(txt); toast('已载入：'+f.name); }}); $('#btnRemote').addEventListener('click',loadRemote); $('#btnPaste').addEventListener('click',pasteClipboard); $('#btnClearInput').addEventListener('click',clearInput); $('#btnSubmitInput').addEventListener('click',submitToInputJs); $('#btnWaitPoll').addEventListener('click',()=>waitAndPollOutput(60)); $('#btnBeautify').addEventListener('click',beautify); $('#btnCopyOut').addEventListener('click',()=>copy('#codeOut','#btnCopyOut')); $('#btnClearAll').addEventListener('click',()=>{ setCodeIn(''); $('#codeOut').textContent=''; $('#status').textContent=''; toast('已清除'); }); $('#btnLoadOutput').addEventListener('click',loadOutput); $('#btnCopyOutput').addEventListener('click',()=>copy('#outputView','#btnCopyOutput')); $('#btnDownloadOutput').addEventListener('click',downloadOutput); }

    window.addEventListener('error', e=> toast('脚本错误: '+(e?.message||'')) );
    window.addEventListener('unhandledrejection', e=> toast('未处理异常: '+(e?.reason?.message||e?.reason||'')) );
    document.addEventListener('DOMContentLoaded', bind);
  </script>
</body>
</html>