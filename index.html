<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OtOjs · 提交后自动轮询（output 直取/可选 deob2）</title>
<style>
  :root{--bg:#0b0f14;--card:#0f1621;--ink:#e6eef7;--muted:#9db1c7;--edge:#1f2937;--edge2:#223046;--btn:#152033;--ok:#10b981;--warn:#f59e0b;--err:#ef4444;--sky:#67e8f9}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink)}
  a{color:var(--sky)}
  .wrap{max-width:880px;margin:0 auto;padding:18px 14px 100px}
  h1{margin:6px 0 10px;font-size:20px}
  .card{background:var(--card);border:1px solid var(--edge);border-radius:12px;padding:12px;margin:10px 0}
  label{font-size:12px;color:var(--muted);margin-right:6px}
  input,select,textarea{width:100%;background:#0f1a2b;color:var(--ink);border:1px solid var(--edge2);border-radius:10px;padding:10px;font-size:13px}
  textarea{min-height:160px;font-family:ui-monospace,Consolas,Menlo,monospace}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0}
  .row>*{flex:1 1 180px}
  button{padding:10px 12px;border-radius:10px;border:1px solid var(--edge2);background:var(--btn);color:var(--ink);cursor:pointer;font-weight:600}
  .ok{border-color:var(--ok)}
  .warn{border-color:var(--warn)}
  .err{border-color:var(--err)}
  pre{white-space:pre-wrap;background:#0b1020;border:1px solid var(--edge2);border-radius:10px;padding:10px;font-size:12px;max-height:420px;overflow:auto}
  small{color:var(--muted)}
  .meter{height:10px;background:#0c1422;border:1px solid var(--edge2);border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,#267cff,#19d4ff);transition:width .2s ease}
  .status{min-height:22px}
  .caps{font-variant:all-small-caps;letter-spacing:.4px}
  .pair{display:flex;gap:8px}
  .pair>*{flex:1}
  .right{display:flex;gap:8px;align-items:center}
  .tag{border:1px solid var(--edge2);border-radius:8px;padding:4px 8px;font-size:12px;color:#a7b6c9}
</style>
</head>
<body>
<div class="wrap">
  <h1>OtOjs · 提交后自动轮询</h1>

  <div class="card">
    <div class="row">
      <div style="flex:2">
        <label>REPO</label>
        <input id="repo" value="Mikephie/OtOjs" />
      </div>
      <div>
        <label>BRANCH</label>
        <input id="branch" value="main" />
      </div>
      <div>
        <label>Token（contents: read+write）</label>
        <input id="token" type="password" placeholder="ghp_..." />
      </div>
    </div>
    <div class="row">
      <div>
        <label>input.js 路径</label>
        <input id="pathIn" value="input.js" />
      </div>
      <div>
        <label>output 选择</label>
        <select id="pathOutSel">
          <option value="output/output.js">output/output.js（第一次解密）</option>
          <option value="output/output.deob2.js">output/output.deob2.js（二次解密）</option>
        </select>
      </div>
      <div>
        <label>提交信息</label>
        <input id="commitMsg" value="update: input.js via UI" />
      </div>
    </div>
  </div>

  <div class="card">
    <small>把待解密脚本放到 <b>input.js</b> → 提交后会自动开始轮询（最长 60 秒） → 在你选择的 <b>output/...js</b> 显示。</small>
    <div class="row">
      <input type="file" id="file" accept=".js,.txt,.json" />
      <button onclick="pick()">选择文件</button>
      <input id="remoteUrl" placeholder="https:// 原始脚本 URL（支持 github/blob 自动转 raw）" />
      <button onclick="loadRemote()">远程加载</button>
      <button onclick="pasteFromClipboard()">粘贴板</button>
      <button class="err" onclick="clrIn()">清空输入</button>
    </div>

    <textarea id="codeIn" placeholder="把待解密的 JS 粘贴到这里，或用上方导入"></textarea>

    <div class="row">
      <button class="ok" onclick="submitAndPoll()">① 提交到 input.js (PUT) 并开始轮询</button>
      <button class="warn" onclick="manualPoll()">② 手动开始轮询（60s）</button>
      <button onclick="beautify()">（可选）结果美化</button>
      <button onclick="copySel('#codeOut', this)">复制结果</button>
      <button class="err" onclick="clrAll()">清空输入与结果</button>
    </div>

    <div class="status" id="status"><small>状态：就绪</small></div>
    <div class="pair">
      <div class="tag" id="shaTag">SHA: -</div>
      <div class="tag" id="ageTag">Age: -</div>
    </div>

    <div class="pair" style="margin:8px 0">
      <div class="tag">选择的 output：<span id="chosenOut">output/output.js</span></div>
      <div class="right">
        <div style="width:100%">
          <div class="meter"><div id="bar" class="bar"></div></div>
        </div>
        <div class="tag caps" id="tick">00 / 60 s</div>
      </div>
    </div>

    <pre id="codeOut" placeholder="结果将显示在这里"></pre>
  </div>

  <div class="card">
    <div class="row">
      <button onclick="loadOutputRaw('output/output.js')">拉取 output.js (Raw)</button>
      <button onclick="loadOutputRaw('output/output.deob2.js')">拉取 output.deob2.js (Raw)</button>
      <button onclick="copySel('#outputRaw', this)">复制</button>
      <button onclick="downloadOutput()">下载 output.js</button>
    </div>
    <pre id="outputRaw"></pre>
  </div>
</div>

<script>
/* ---------- 工具 ---------- */
const $=s=>document.querySelector(s);
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
function nowISO(){ return new Date().toISOString(); }
function setStatus(msg){ $('#status').innerHTML = '<small>状态：'+ msg +'</small>'; }
function ghHeaders(){
  const t=$('#token').value.trim();
  if(!t) throw new Error('缺少 Token（需要 contents: read & write）');
  return { 'Authorization':'Bearer '+t, 'Accept':'application/vnd.github+json' };
}
function repoBase(){ return `https://api.github.com/repos/${$('#repo').value.trim()}` }
function rawUrl(path){ return `https://raw.githubusercontent.com/${$('#repo').value.trim()}/${$('#branch').value.trim()}/${path}` }
function pick(){ $('#file').click(); }
$('#file').addEventListener('change', async (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  const txt=await f.text(); $('#codeIn').value=txt; setStatus('已载入本地文件：'+f.name+' · '+txt.length+' 字符');
});
$('#pathOutSel').addEventListener('change', ()=>$('#chosenOut').textContent=$('#pathOutSel').value);

/* ---------- 远程/剪贴板/清空 ---------- */
async function loadRemote(){
  let u=$('#remoteUrl').value.trim(); if(!u){ setStatus('请输入 URL'); return }
  if(/https?:\/\/github\.com\/.+\/blob\//.test(u)){
    u=u.replace('https://github.com/','https://raw.githubusercontent.com/').replace('/blob/','/');
  }
  try{
    const r=await fetch(u,{cache:'no-cache'}); const t=await r.text();
    if(!r.ok) throw new Error(r.status+' '+r.statusText+' · '+t.slice(0,200));
    $('#codeIn').value=t; setStatus('远程已加载 · '+t.length+' 字符');
  }catch(e){ setStatus('远程加载失败：'+e.message); }
}
async function pasteFromClipboard(){
  try{ const t=await navigator.clipboard.readText(); $('#codeIn').value=t; setStatus('已从剪贴板粘贴 · '+t.length+' 字符'); }
  catch(e){ setStatus('粘贴失败：'+e.message); }
}
function clrIn(){ $('#codeIn').value=''; setStatus('已清空输入'); }
function clrAll(){ $('#codeIn').value=''; $('#codeOut').textContent=''; $('#outputRaw').textContent=''; setStatus('已清空输入与结果'); $('#shaTag').textContent='SHA: -'; $('#ageTag').textContent='Age: -'; }

/* ---------- GitHub API 基础 ---------- */
async function getContent(path){
  const api=`${repoBase()}/contents/${path}?ref=${$('#branch').value.trim()}`;
  const r=await fetch(api,{headers:ghHeaders()});
  const body=await r.text();
  if(!r.ok) return { ok:false, status:r.status, statusText:r.statusText, body };
  try{
    const j=JSON.parse(body);
    const b64=(j.content||'').replace(/\n/g,'');
    const text=j.content?decodeURIComponent(escape(atob(b64))):'';
    return { ok:true, sha:j.sha||'', text, raw:j, fetchedAt:Date.now() };
  }catch(e){
    return { ok:false, status:r.status, statusText:'JSON parse error', body:body.slice(0,200) };
  }
}
async function putContent(path, code, message){
  const api=`${repoBase()}/contents/${path}`;
  // 先探测是否存在，拿 sha
  let sha='';
  try{
    const head=await fetch(`${api}?ref=${$('#branch').value.trim()}`,{headers:ghHeaders()});
    if(head.ok){ const j=await head.json(); sha=j.sha||''; }
  }catch(_){}
  const body={ message: message||('update via UI @ '+nowISO()), content: btoa(unescape(encodeURIComponent(code))), branch: $('#branch').value.trim(), sha: sha||undefined };
  const res=await fetch(api,{ method:'PUT', headers:{ 'Content-Type':'application/json', ...ghHeaders() }, body: JSON.stringify(body) });
  const txt=await res.text();
  if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText} · ${txt.slice(0,200)}`);
  const j=JSON.parse(txt);
  return { sha: (j.content&&j.content.sha)||'-', commitSha: (j.commit&&j.commit.sha)||'-' };
}

/* ---------- 提交 + 自动轮询 ---------- */
async function submitAndPoll(){
  const inPath=$('#pathIn').value.trim()||'input.js';
  const outPath=$('#pathOutSel').value;
  const code=$('#codeIn').value; if(!code){ setStatus('没有可上传的内容'); return }
  try{
    setStatus('上传中…');
    const res=await putContent(inPath, code, $('#commitMsg').value.trim());
    setStatus('提交成功，commit '+res.commitSha.slice(0,7)+' · 开始轮询 '+outPath);
    $('#shaTag').textContent='SHA: '+res.sha.slice(0,7)+'…';
    startPolling(outPath, 60);  // 自动开始轮询
  }catch(e){ setStatus('提交失败：'+e.message); }
}
function manualPoll(){ startPolling($('#pathOutSel').value, 60); }

let pollingCtl = { stop:false };
async function startPolling(path, seconds){
  pollingCtl.stop=false;
  $('#chosenOut').textContent=path;
  const tick=$('#tick'), bar=$('#bar');
  const t0=Date.now(); let lastMsg='', lastSha='', lastLen=0, lastTime=0;

  for(let s=0; s<=seconds; s++){
    if(pollingCtl.stop) return;
    const pct=Math.min(100, Math.floor(s/seconds*100));
    bar.style.width = pct + '%';
    tick.textContent = String(s).padStart(2,'0')+' / '+seconds+' s';

    try{
      const got=await getContent(path);
      if(got.ok){
        const len=got.text.length||0;
        const changedSha = (got.raw.sha||'') !== lastSha;
        const changedLen = len !== lastLen;
        const changedTime = (got.raw?.sha) && (got.fetchedAt - lastTime > 0); // 仅用于记录

        $('#shaTag').textContent='SHA: '+(got.raw.sha||'-').slice(0,7)+'…';
        const ageSec = Math.max(0, Math.floor((Date.now() - new Date(got.raw?.sha ? got.raw.git_url?.time : Date.now()))/1000));
        $('#ageTag').textContent='Age: '+Math.floor((Date.now()-got.fetchedAt)/1000)+'s';

        // “非旧内容”判断：长度变化 或 sha 变化（只要有其一）
        if((got.text && got.text.trim()) && (changedSha || changedLen)){
          $('#codeOut').textContent=got.text;
          setStatus('✅ 已获取到 '+path+' · 长度 '+len+' · '+(changedSha?'sha 变化':'内容变化'));
          bar.style.width='100%'; tick.textContent=seconds+' / '+seconds+' s';
          return;
        }else{
          lastSha = got.raw.sha||''; lastLen=len; lastTime=got.fetchedAt;
          lastMsg = '未变化';
        }
      }else{
        lastMsg = 'HTTP '+got.status+' '+got.statusText;
      }
    }catch(e){
      lastMsg='异常：'+e.message;
    }

    setStatus('等待中… '+s+'/'+seconds+'s · 目标 '+path+' · 上次：'+lastMsg);
    await sleep(1000);
  }

  setStatus('⌛ 超时 '+seconds+'s，仍未检测到新内容（可稍后再点“拉取 Raw”或延长等待）');
}

/* ---------- Raw 拉取/下载/复制 ---------- */
async function loadOutputRaw(path){
  try{
    const r=await fetch(rawUrl(path),{cache:'no-cache'});
    const t=await r.text();
    if(!r.ok) throw new Error(r.status+' '+r.statusText);
    $('#outputRaw').textContent=t;
    setStatus('已拉取 '+path+' Raw · '+t.length+' 字符');
  }catch(e){ $('#outputRaw').textContent='拉取失败：'+e.message+'\n'+rawUrl(path); setStatus('Raw 拉取失败'); }
}
function downloadOutput(){
  const t=$('#outputRaw').textContent||$('#codeOut').textContent||'';
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([t],{type:'text/javascript;charset=utf-8'}));
  a.download='output.js'; a.click(); URL.revokeObjectURL(a.href);
}
async function copySel(sel,btn){
  try{
    const el=$(sel); const t=el?(el.value??el.textContent??''):'';
    await navigator.clipboard.writeText(t);
    const txt=btn.textContent; btn.textContent='✅ 已复制'; setTimeout(()=>btn.textContent=txt,1200);
  }catch(e){ setStatus('复制失败：'+e.message); }
}

/* ---------- 美化 ---------- */
async function ensurePrettier(){
  if(window.prettier && window.prettierPlugins?.babel) return;
  const s1=document.createElement('script'); s1.src='https://unpkg.com/prettier@3.2.5/standalone.js';
  const s2=document.createElement('script'); s2.src='https://unpkg.com/prettier@3.2.5/plugins/babel.js';
  document.body.appendChild(s1); await new Promise(r=>s1.onload=r);
  document.body.appendChild(s2); await new Promise(r=>s2.onload=r);
}
async function beautify(){
  let s=$('#codeOut').textContent || $('#codeIn').value || '';
  if(!s){ setStatus('无待美化内容'); return }
  try{
    await ensurePrettier();
    const out=prettier.format(s,{parser:'babel',plugins:[prettierPlugins.babel]});
    $('#codeOut').textContent=out; setStatus('已用 Prettier 美化');
  }catch(e){ setStatus('Prettier 失败：'+e.message); }
}
</script>
</body>
</html>